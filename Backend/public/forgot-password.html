<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Amhara Media Corporation</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* ============================================
           FORGOT PASSWORD PAGE STYLES
           Matches the login page design system
        ============================================ */
        
        /* CSS Variables (Consistent with login page) */
        :root {
            --reporter-color: #3498db;
            --editor-color: #e67e22;
            --crew-color: #2ecc71;
            --requester-color: #9b59b6;
            --admin-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Base Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
            overflow-x: hidden;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Main Container */
        .forgot-password-container {
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        /* Card Styling */
        .password-reset-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border-top: 5px solid var(--reporter-color);
        }
        
        /* Logo Section */
        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            color: white;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .logo-icon {
            background: rgba(255, 255, 255, 0.15);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .tagline {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1rem;
            letter-spacing: 0.5px;
        }
        
        /* Back to Login Link */
        .back-to-login {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        
        .back-to-login a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 50px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-to-login a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-3px);
        }
        
        /* Header */
        .password-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .password-header h2 {
            color: var(--dark-bg);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .password-header p {
            color: #6c757d;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        /* Form Styles */
        .form-label {
            font-weight: 600;
            color: var(--dark-bg);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-control {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--reporter-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .form-text {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* Steps Container */
        .steps-container {
            margin-bottom: 30px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 30px;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-circle {
            background: var(--reporter-color);
            border-color: var(--reporter-color);
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-circle {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        
        .step-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .step.active .step-label {
            color: var(--dark-bg);
            font-weight: 600;
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--reporter-color), #2980b9);
            border: none;
            padding: 14px;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 10px;
            color: white;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.7;
            transform: none !important;
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid #dee2e6;
            color: #6c757d;
            padding: 12px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-secondary:hover {
            background: var(--light-bg);
            color: #495057;
            border-color: #ced4da;
        }
        
        /* Success Message */
        .success-message {
            text-align: center;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success-color), #218838);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .success-message h3 {
            color: var(--success-color);
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .success-message p {
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        /* Security Info */
        .security-info {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.2));
            border-left: 4px solid var(--info-color);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .security-info h6 {
            color: var(--dark-bg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .security-info ul {
            margin: 0;
            padding-left: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Loading Spinner */
        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        
        /* Alert Styles */
        .alert {
            border-radius: 12px;
            padding: 15px 20px;
            border: none;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.2));
            border-left: 4px solid var(--success-color);
            color: var(--dark-bg);
        }
        
        .alert-warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.2));
            border-left: 4px solid var(--warning-color);
            color: var(--dark-bg);
        }
        
        .alert-danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.2));
            border-left: 4px solid var(--danger-color);
            color: var(--dark-bg);
        }
        
        /* Toast Container */
        .toast-container {
            z-index: 9999;
            max-width: 350px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .forgot-password-container {
                max-width: 95%;
            }
            
            .password-reset-card {
                padding: 30px 25px;
            }
            
            .back-to-login {
                top: 15px;
                left: 15px;
            }
            
            .back-to-login a {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
            
            .logo {
                font-size: 1.8rem;
            }
            
            .logo-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 576px) {
            body {
                padding: 15px;
            }
            
            .password-reset-card {
                padding: 25px 20px;
            }
            
            .password-header h2 {
                font-size: 1.5rem;
            }
            
            .step-label {
                font-size: 0.75rem;
            }
            
            .btn-primary, .btn-secondary {
                padding: 12px;
            }
            
            .success-icon {
                width: 70px;
                height: 70px;
                font-size: 2rem;
            }
        }
        
        @media (max-width: 400px) {
            .password-reset-card {
                padding: 20px 15px;
            }
            
            .step-indicator {
                margin-bottom: 20px;
            }
            
            .step-circle {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Back to Login Link -->
    <div class="back-to-login">
        <a href="index.html">
            <i class="bi bi-arrow-left"></i>
            <span>Back to Login</span>
        </a>
    </div>

    <!-- Main Container -->
    <div class="forgot-password-container">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="logo">
                <div class="logo-icon">
                    <i class="bi bi-broadcast"></i>
                </div>
                <span>Amhara Media Corporation</span>
            </div>
            <p class="tagline">Content Management System</p>
        </div>

        <!-- Password Reset Card -->
        <div class="password-reset-card">
            <!-- Header -->
            <div class="password-header">
                <h2>Reset Your Password</h2>
                <p>Enter your email address and we'll send you a link to reset your password.</p>
            </div>

            <!-- Step Indicator -->
            <div class="steps-container">
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <span class="step-label">Enter Email</span>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <span class="step-label">Verify Code</span>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <span class="step-label">New Password</span>
                    </div>
                </div>
            </div>

            <!-- Step 1: Email Entry Form -->
            <form id="emailForm" class="step-form active-step">
                <div class="mb-4">
                    <label for="email" class="form-label">
                        <i class="bi bi-envelope me-1"></i>
                        Email Address
                    </label>
                    <input type="email" class="form-control" id="email" 
                           placeholder="Enter your registered email address" required>
                    <div class="form-text">
                        Enter the email address associated with your account.
                    </div>
                </div>
                
                <div class="d-grid mb-3">
                    <button type="submit" class="btn btn-primary" id="sendCodeBtn">
                        <i class="bi bi-send me-2"></i>
                        Send Reset Code
                    </button>
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">
                        <i class="bi bi-arrow-left me-1"></i>
                        Back to Login
                    </button>
                </div>
            </form>

            <!-- Step 2: Verification Code Form -->
            <form id="codeForm" class="step-form" style="display: none;">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    A verification code has been sent to <strong id="userEmail"></strong>.
                    Please check your email and enter the code below.
                </div>
                
                <div class="mb-4">
                    <label for="verificationCode" class="form-label">
                        <i class="bi bi-shield-check me-1"></i>
                        Verification Code
                    </label>
                    <input type="text" class="form-control text-center" id="verificationCode" 
                           placeholder="Enter 6-digit code" maxlength="6" required>
                    <div class="form-text">
                        Enter the 6-digit code sent to your email.
                    </div>
                </div>
                
                <div class="d-grid mb-3">
                    <button type="submit" class="btn btn-primary" id="verifyCodeBtn">
                        <i class="bi bi-check-circle me-2"></i>
                        Verify Code
                    </button>
                </div>
                
                <div class="d-grid mb-3">
                    <button type="button" class="btn btn-secondary" id="resendCodeBtn">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Resend Code
                    </button>
                </div>
                
                <div class="text-center">
                    <button type="button" class="btn btn-link text-decoration-none" id="changeEmailBtn">
                        <i class="bi bi-pencil me-1"></i>
                        Use different email address
                    </button>
                </div>
            </form>

            <!-- Step 3: New Password Form -->
            <form id="passwordForm" class="step-form" style="display: none;">
                <div class="alert alert-success mb-4">
                    <i class="bi bi-check-circle me-2"></i>
                    Code verified! Now create your new password.
                </div>
                
                <div class="mb-4">
                    <label for="newPassword" class="form-label">
                        <i class="bi bi-lock me-1"></i>
                        New Password
                    </label>
                    <input type="password" class="form-control" id="newPassword" 
                           placeholder="Enter new password" required>
                    <div class="form-text">
                        Must be at least 8 characters with uppercase, lowercase, and numbers.
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="confirmPassword" class="form-label">
                        <i class="bi bi-lock-fill me-1"></i>
                        Confirm Password
                    </label>
                    <input type="password" class="form-control" id="confirmPassword" 
                           placeholder="Confirm new password" required>
                    <div class="form-text">
                        Re-enter your new password to confirm.
                    </div>
                </div>
                
                <!-- Password Strength Meter -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="form-text">Password Strength:</span>
                        <span id="passwordStrength" class="form-text">Weak</span>
                    </div>
                    <div class="progress" style="height: 5px;">
                        <div id="passwordStrengthBar" class="progress-bar bg-danger" 
                             role="progressbar" style="width: 20%"></div>
                    </div>
                </div>
                
                <div class="d-grid mb-3">
                    <button type="submit" class="btn btn-primary" id="resetPasswordBtn">
                        <i class="bi bi-key me-2"></i>
                        Reset Password
                    </button>
                </div>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">
                        <i class="bi bi-house me-1"></i>
                        Back to Login
                    </button>
                </div>
            </form>

            <!-- Success Message (Hidden by default) -->
            <div id="successMessage" class="success-message" style="display: none;">
                <div class="success-icon">
                    <i class="bi bi-check-lg"></i>
                </div>
                <h3>Password Reset Successful!</h3>
                <p>Your password has been successfully reset. You can now log in with your new password.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        Go to Login
                    </button>
                </div>
            </div>

            <!-- Security Information -->
            <div class="security-info">
                <h6><i class="bi bi-shield-lock"></i> Security Tips</h6>
                <ul>
                    <li>Never share your password with anyone</li>
                    <li>Use a unique password for this account</li>
                    <li>Consider using a password manager</li>
                    <li>Enable two-factor authentication if available</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ===========================================
        // FORGOT PASSWORD IMPLEMENTATION
        // ===========================================
        
        // State management
        const state = {
            currentStep: 1,
            userEmail: '',
            verificationCode: '',
            resetAttempts: 0,
            maxAttempts: 3,
            lastResendTime: null,
            resendCooldown: 60 // seconds
        };

        // DOM Elements
        const elements = {
            emailForm: document.getElementById('emailForm'),
            codeForm: document.getElementById('codeForm'),
            passwordForm: document.getElementById('passwordForm'),
            successMessage: document.getElementById('successMessage'),
            userEmail: document.getElementById('userEmail'),
            verificationCode: document.getElementById('verificationCode'),
            newPassword: document.getElementById('newPassword'),
            confirmPassword: document.getElementById('confirmPassword'),
            passwordStrength: document.getElementById('passwordStrength'),
            passwordStrengthBar: document.getElementById('passwordStrengthBar'),
            sendCodeBtn: document.getElementById('sendCodeBtn'),
            verifyCodeBtn: document.getElementById('verifyCodeBtn'),
            resetPasswordBtn: document.getElementById('resetPasswordBtn'),
            resendCodeBtn: document.getElementById('resendCodeBtn'),
            changeEmailBtn: document.getElementById('changeEmailBtn')
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved state from localStorage
            loadState();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for cooldown
            checkResendCooldown();
            
            console.log('âœ… Forgot password page ready');
        });

        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('amecoPasswordResetState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(state, parsedState);
                
                // Restore UI state if user was in the middle of reset
                if (state.currentStep > 1 && state.userEmail) {
                    goToStep(state.currentStep);
                    elements.userEmail.textContent = state.userEmail;
                }
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('amecoPasswordResetState', JSON.stringify(state));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Email form submission
            elements.emailForm.addEventListener('submit', handleEmailSubmit);
            
            // Code form submission
            elements.codeForm.addEventListener('submit', handleCodeSubmit);
            
            // Password form submission
            elements.passwordForm.addEventListener('submit', handlePasswordSubmit);
            
            // Resend code button
            elements.resendCodeBtn.addEventListener('click', handleResendCode);
            
            // Change email button
            elements.changeEmailBtn.addEventListener('click', handleChangeEmail);
            
            // Password strength checker
            elements.newPassword.addEventListener('input', checkPasswordStrength);
            
            // Auto-focus on code input
            elements.verificationCode.addEventListener('input', function() {
                if (this.value.length === 6) {
                    elements.verifyCodeBtn.click();
                }
            });
        }

        // Handle email submission
        async function handleEmailSubmit(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            
            if (!validateEmail(email)) {
                showToast('Please enter a valid email address', 'warning');
                return;
            }
            
            // Show loading state
            const originalText = elements.sendCodeBtn.innerHTML;
            elements.sendCodeBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i> Sending...';
            elements.sendCodeBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // Check if email exists in system
                if (checkIfEmailExists(email)) {
                    // Save email to state
                    state.userEmail = email;
                    state.currentStep = 2;
                    state.lastResendTime = Date.now();
                    saveState();
                    
                    // Update UI
                    elements.userEmail.textContent = email;
                    goToStep(2);
                    
                    // Show success message
                    showToast('Verification code sent to your email', 'success');
                } else {
                    showToast('No account found with this email address', 'warning');
                }
                
                // Reset button
                elements.sendCodeBtn.innerHTML = originalText;
                elements.sendCodeBtn.disabled = false;
            }, 1500);
        }

        // Handle code verification
        async function handleCodeSubmit(event) {
            event.preventDefault();
            
            const code = elements.verificationCode.value.trim();
            
            if (!code || code.length !== 6) {
                showToast('Please enter a valid 6-digit code', 'warning');
                return;
            }
            
            // Show loading state
            const originalText = elements.verifyCodeBtn.innerHTML;
            elements.verifyCodeBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i> Verifying...';
            elements.verifyCodeBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // In a real app, this would verify against the server
                // For demo, accept any 6-digit code
                if (code.length === 6) {
                    state.verificationCode = code;
                    state.currentStep = 3;
                    saveState();
                    
                    // Update UI
                    goToStep(3);
                    showToast('Code verified successfully', 'success');
                } else {
                    showToast('Invalid verification code', 'danger');
                    elements.verificationCode.value = '';
                }
                
                // Reset button
                elements.verifyCodeBtn.innerHTML = originalText;
                elements.verifyCodeBtn.disabled = false;
            }, 1500);
        }

        // Handle password reset
        async function handlePasswordSubmit(event) {
            event.preventDefault();
            
            const newPassword = elements.newPassword.value;
            const confirmPassword = elements.confirmPassword.value;
            
            // Validate passwords
            if (!validatePassword(newPassword)) {
                showToast('Password must be at least 8 characters with uppercase, lowercase, and numbers', 'warning');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'warning');
                elements.confirmPassword.focus();
                return;
            }
            
            // Show loading state
            const originalText = elements.resetPasswordBtn.innerHTML;
            elements.resetPasswordBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i> Resetting...';
            elements.resetPasswordBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // In a real app, this would update password on server
                updatePasswordInSystem(state.userEmail, newPassword);
                
                // Clear state
                clearState();
                
                // Show success message
                showSuccessMessage();
                showToast('Password reset successful!', 'success');
                
                // Reset button (though it will be hidden)
                elements.resetPasswordBtn.innerHTML = originalText;
                elements.resetPasswordBtn.disabled = false;
            }, 2000);
        }

        // Handle resend code
        function handleResendCode() {
            if (checkResendCooldown()) {
                showToast('Please wait before requesting a new code', 'warning');
                return;
            }
            
            // Show loading
            const originalText = elements.resendCodeBtn.innerHTML;
            elements.resendCodeBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i> Sending...';
            elements.resendCodeBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // Update state
                state.lastResendTime = Date.now();
                state.resetAttempts++;
                saveState();
                
                // Update UI
                updateResendButton();
                showToast('New verification code sent', 'success');
                
                // Reset button
                elements.resendCodeBtn.innerHTML = originalText;
                elements.resendCodeBtn.disabled = false;
            }, 1000);
        }

        // Handle change email
        function handleChangeEmail() {
            state.currentStep = 1;
            saveState();
            goToStep(1);
            document.getElementById('email').value = state.userEmail;
            document.getElementById('email').focus();
        }

        // Navigate to step
        function goToStep(step) {
            // Hide all forms
            document.querySelectorAll('.step-form').forEach(form => {
                form.style.display = 'none';
            });
            elements.successMessage.style.display = 'none';
            
            // Update step indicator
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            // Show current step form
            if (step === 1) {
                elements.emailForm.style.display = 'block';
                document.getElementById('email').focus();
            } else if (step === 2) {
                elements.codeForm.style.display = 'block';
                elements.verificationCode.focus();
                updateResendButton();
            } else if (step === 3) {
                elements.passwordForm.style.display = 'block';
                elements.newPassword.focus();
            }
            
            state.currentStep = step;
            saveState();
        }

        // Check password strength
        function checkPasswordStrength() {
            const password = elements.newPassword.value;
            let strength = 0;
            let strengthText = 'Weak';
            let strengthColor = 'danger';
            let width = 20;
            
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            switch(strength) {
                case 1:
                    strengthText = 'Weak';
                    strengthColor = 'danger';
                    width = 20;
                    break;
                case 2:
                    strengthText = 'Fair';
                    strengthColor = 'warning';
                    width = 40;
                    break;
                case 3:
                    strengthText = 'Good';
                    strengthColor = 'info';
                    width = 60;
                    break;
                case 4:
                    strengthText = 'Strong';
                    strengthColor = 'primary';
                    width = 80;
                    break;
                case 5:
                    strengthText = 'Very Strong';
                    strengthColor = 'success';
                    width = 100;
                    break;
            }
            
            elements.passwordStrength.textContent = strengthText;
            elements.passwordStrengthBar.className = `progress-bar bg-${strengthColor}`;
            elements.passwordStrengthBar.style.width = `${width}%`;
        }

        // Update resend button state
        function updateResendButton() {
            const cooldownRemaining = getCooldownRemaining();
            
            if (cooldownRemaining > 0) {
                elements.resendCodeBtn.disabled = true;
                elements.resendCodeBtn.innerHTML = `<i class="bi bi-clock me-1"></i>Resend (${cooldownRemaining}s)`;
                
                // Update countdown every second
                const interval = setInterval(() => {
                    const remaining = getCooldownRemaining();
                    if (remaining > 0) {
                        elements.resendCodeBtn.innerHTML = `<i class="bi bi-clock me-1"></i>Resend (${remaining}s)`;
                    } else {
                        clearInterval(interval);
                        elements.resendCodeBtn.disabled = false;
                        elements.resendCodeBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Resend Code';
                    }
                }, 1000);
            } else {
                elements.resendCodeBtn.disabled = false;
                elements.resendCodeBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Resend Code';
            }
        }

        // Check resend cooldown
        function checkResendCooldown() {
            return getCooldownRemaining() > 0;
        }

        // Get remaining cooldown time
        function getCooldownRemaining() {
            if (!state.lastResendTime) return 0;
            
            const now = Date.now();
            const elapsed = Math.floor((now - state.lastResendTime) / 1000);
            const remaining = state.resendCooldown - elapsed;
            
            return remaining > 0 ? remaining : 0;
        }

        // Show success message
        function showSuccessMessage() {
            // Hide all forms
            document.querySelectorAll('.step-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Show success message
            elements.successMessage.style.display = 'block';
            
            // Hide step indicator
            document.querySelector('.steps-container').style.display = 'none';
        }

        // Clear state
        function clearState() {
            state.currentStep = 1;
            state.userEmail = '';
            state.verificationCode = '';
            state.resetAttempts = 0;
            state.lastResendTime = null;
            saveState();
            localStorage.removeItem('amecoPasswordResetState');
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        // Validate email format
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Validate password strength
        function validatePassword(password) {
            return password.length >= 8 && 
                   /[A-Z]/.test(password) && 
                   /[a-z]/.test(password) && 
                   /[0-9]/.test(password);
        }

        // Check if email exists in system
        function checkIfEmailExists(email) {
            // Check demo users
            const demoUsers = {
                'reporter@ameco.et': true,
                'editor@ameco.et': true,
                'crew@ameco.et': true,
                'admin@ameco.et': true,
                'master@ameco.et': true
            };
            
            // Check real users in localStorage
            try {
                const realUsers = JSON.parse(localStorage.getItem('amecoRealUsers') || '{}');
                if (realUsers[email]) return true;
            } catch (e) {
                console.error('Error reading users:', e);
            }
            
            return demoUsers[email] || false;
        }

        // Update password in system
        function updatePasswordInSystem(email, newPassword) {
            // Update in demo users (in memory only)
            const demoUsers = {
                'reporter@ameco.et': { password: newPassword },
                'editor@ameco.et': { password: newPassword },
                'crew@ameco.et': { password: newPassword },
                'admin@ameco.et': { password: newPassword }
            };
            
            // Update in real users (localStorage)
            try {
                const realUsers = JSON.parse(localStorage.getItem('amecoRealUsers') || '{}');
                if (realUsers[email]) {
                    realUsers[email].password = newPassword;
                    realUsers[email].lastPasswordChange = new Date().toISOString();
                    localStorage.setItem('amecoRealUsers', JSON.stringify(realUsers));
                    
                    // Log password change
                    console.log(`Password updated for: ${email}`);
                }
            } catch (e) {
                console.error('Error updating password:', e);
            }
            
            // For demo users, just log it
            if (demoUsers[email]) {
                console.log(`Demo password would be updated for: ${email}`);
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            const toastId = 'toast-' + Date.now();
            const iconMap = {
                'success': 'bi-check-circle',
                'danger': 'bi-exclamation-circle',
                'warning': 'bi-exclamation-triangle',
                'info': 'bi-info-circle'
            };
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${iconMap[type] || 'bi-info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Add animation styles for spinner
        const style = document.createElement('style');
        style.textContent = `
            .spin { animation: spin 1s linear infinite; display: inline-block; }
            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>