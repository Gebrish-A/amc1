<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requester Dashboard - Amhara Media</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, var(--secondary-color) 0%, #1a1a2e 100%);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            padding: 0;
            box-shadow: 3px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .sidebar .logo {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar .logo h3 {
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #3498db, #8e44ad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .sidebar-menu {
            padding: 1rem 0;
            height: calc(100vh - 180px);
            overflow-y: auto;
        }

        .sidebar-menu .nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 0.85rem 1.5rem;
            margin: 0.25rem 1rem;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            font-weight: 500;
        }

        .sidebar-menu .nav-link:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(142, 68, 173, 0.2));
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sidebar-menu .nav-link.active {
            background: linear-gradient(135deg, #3498db, #8e44ad);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .user-profile {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
        }

        .avatar-initials {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3498db, #8e44ad);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            background: #f8fafc;
        }

        .navbar-top {
            background: white;
            padding: 1.2rem 2.5rem;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .content-wrapper {
            padding: 2.5rem;
        }

        /* Stats Cards */
        .stats-card {
            padding: 1.5rem;
            border-radius: 20px;
            color: white;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            height: 100%;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
        }

        .stats-card:hover::before {
            transform: rotate(45deg) translate(50%, 50%);
        }

        .stats-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(52, 152, 219, 0.3);
        }

        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .stats-card .count {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin: 0.5rem 0;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stats-card .label {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            font-weight: 500;
        }

        /* Dashboard Cards */
        .dashboard-card {
            border-radius: 20px;
            border: none;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 2rem;
            background: white;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .dashboard-card .card-header {
            background: linear-gradient(135deg, #f8fafc, #e9ecef);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.5rem 2rem;
            border-radius: 20px 20px 0 0 !important;
        }

        .dashboard-card .card-header h5 {
            margin: 0;
            color: var(--secondary-color);
            font-weight: 700;
            font-size: 1.25rem;
        }

        /* Status badges */
        .status-badge {
            padding: 0.35rem 1rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .status-pending {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border-color: #ffc107;
        }

        .status-approved {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-color: #28a745;
        }

        .status-rejected {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border-color: #dc3545;
        }

        .status-in-progress {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border-color: #17a2b8;
        }

        .status-completed {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border-color: #20c997;
        }

        .status-draft {
            background: linear-gradient(135deg, #e2e3e5, #d6d8db);
            color: #383d41;
            border-color: #6c757d;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-color), #8e44ad);
            color: white;
            border-radius: 25px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 15px 35px rgba(52, 152, 219, 0.2);
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100"><path fill="rgba(255,255,255,0.05)" d="M0,0L1000,100V0H0Z"/></svg>');
            background-size: cover;
        }

        .welcome-banner h1 {
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .welcome-banner p {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
            max-width: 600px;
            margin-bottom: 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state i {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state h4 {
            color: var(--secondary-color);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .empty-state p {
            color: #6c757d;
            max-width: 400px;
            margin: 0 auto 2rem;
            font-size: 1rem;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--secondary-color);
            transition: all 0.3s;
        }

        .mobile-menu-toggle:hover {
            color: var(--primary-color);
            transform: rotate(90deg);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .content-wrapper {
                padding: 1.5rem;
            }

            .welcome-banner h1 {
                font-size: 1.5rem;
            }

            .stats-card {
                min-height: 160px;
                padding: 1rem;
            }

            .stats-card .count {
                font-size: 2rem;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }

        /* Get Started Section */
        .get-started-section {
            background: white;
            border-radius: 25px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .get-started-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), #8e44ad);
        }

        .feature-card {
            text-align: center;
            padding: 2rem 1rem;
            border-radius: 20px;
            background: #f8fafc;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%;
            position: relative;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .feature-card:hover {
            background: white;
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .feature-card i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        .feature-card h5 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-bottom: 0.75rem;
            font-size: 1.2rem;
        }

        .feature-card p {
            color: #6c757d;
            line-height: 1.5;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        /* Form Styles */
        .form-section {
            background: white;
            border-radius: 25px;
            padding: 2rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .form-header h2 {
            color: var(--secondary-color);
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), #8e44ad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-header p {
            color: #6c757d;
            font-size: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-label {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label.required::after {
            content: '*';
            color: var(--accent-color);
            margin-left: 0.25rem;
        }

        .form-control,
        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f8fafc;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            background: white;
            transform: translateY(-2px);
        }

        .form-control-lg {
            padding: 0.875rem 1.25rem;
            font-size: 1rem;
        }

        .file-upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 2rem 1rem;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            height: 100%;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.05);
            transform: translateY(-2px);
        }

        .file-upload-area.drag-over {
            border-color: var(--primary-color);
            background: rgba(52, 152, 219, 0.1);
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .file-upload-text h5 {
            color: var(--secondary-color);
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .file-upload-text p {
            color: #6c757d;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .file-preview {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 1rem;
            margin-top: 1rem;
            background: white;
            transition: all 0.3s;
        }

        .file-preview:hover {
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8fafc;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), #8e44ad);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 0.25rem;
            word-break: break-word;
            font-size: 0.9rem;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .file-remove {
            color: var(--accent-color);
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .file-remove:hover {
            background: rgba(231, 76, 60, 0.1);
            transform: scale(1.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.4);
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
        }

        .btn-outline-primary {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #f1f3f5;
        }

        /* Request card styles */
        .request-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 6px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .request-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), #8e44ad);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .request-card:hover::before {
            opacity: 1;
        }

        .request-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .request-card.pending {
            border-left-color: #ffc107;
        }

        .request-card.approved {
            border-left-color: #28a745;
        }

        .request-card.rejected {
            border-left-color: #dc3545;
        }

        .request-card.in-progress {
            border-left-color: #17a2b8;
        }

        .request-card.completed {
            border-left-color: #20c997;
        }

        .request-card.draft {
            border-left-color: #6c757d;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 2rem 0;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #e9ecef;
            transform: translateY(-50%);
            z-index: 1;
        }

        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            background: white;
            border: 4px solid #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            font-size: 1.2rem;
            color: #6c757d;
            transition: all 0.3s;
        }

        .step-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.8rem;
        }

        .progress-step.active .step-icon {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .progress-step.active .step-label {
            color: var(--primary-color);
        }

        /* Other Category Input */
        .other-category-container {
            display: none;
            margin-top: 0.5rem;
        }

        /* Custom Category Chip */
        .custom-category-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.25rem;
        }

        .custom-category-chip i {
            cursor: pointer;
        }

        /* My Requests Layout Improvements */
        .request-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .request-meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .request-meta-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
        }

        .request-meta-value {
            font-size: 0.95rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        /* Filter Section */
        .requests-filter {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
        }
    </style>
</head>

<body>
    <!-- Request Details Modal -->
    <div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="requestModalBody">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <h3>AMC</h3>
            <span class="badge bg-light text-dark mt-2" id="userRoleBadge">Requester</span>
        </div>

        <div class="sidebar-menu">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" id="dashboardLink">
                        <i class="bi bi-speedometer2"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="newRequestLink">
                        <i class="bi bi-plus-circle"></i>
                        <span>New Request</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="myRequestsLink">
                        <i class="bi bi-file-earmark-text"></i>
                        <span>My Requests</span>
                        <span class="badge bg-info ms-auto" id="requestsBadge">0</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="user-profile">
            <div class="user-info d-flex align-items-center gap-3">
                <div class="avatar-initials" id="userAvatar">
                    RQ
                </div>
                <div class="user-details">
                    <h6 class="mb-0" id="userName">Content Requester</h6>
                    <small class="text-white-50" id="userEmail">requester@amc.et</small>
                </div>
                <button class="btn btn-sm btn-outline-light ms-auto" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navbar -->
        <nav class="navbar-top">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div class="d-flex align-items-center gap-3">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">
                        <i class="bi bi-list"></i>
                    </button>
                    <div>
                        <h4 class="mb-0 fw-bold" id="pageTitle">Content Requester Dashboard</h4>
                        <small class="text-muted" id="currentDate"></small>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="position-relative">
                        <button class="btn btn-light position-relative" id="notificationsBtn">
                            <i class="bi bi-bell"></i>
                            <span
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                id="notificationCount">
                                0
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="content-wrapper" id="dashboardSection">
            <!-- New User View (Empty State) -->
            <div id="newUserView" style="display: none;">
                <!-- Welcome Banner for New User -->
                <div class="welcome-banner fade-in">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 id="welcomeMessageNew">Welcome to AMC Content System!</h1>
                            <p>Get started by creating your first content request. The system is ready for you to begin.
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="bg-white text-dark rounded-pill px-3 py-2 d-inline-block">
                                <i class="bi bi-calendar-check me-2"></i>
                                <span id="currentTime"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Get Started Section -->
                <div class="get-started-section fade-in">
                    <h3 class="text-center mb-4">Let's Get Started</h3>
                    <p class="text-center text-muted mb-4">Follow these simple steps to begin using the AMC Content
                        System</p>

                    <div class="row g-4 justify-content-center">
                        <div class="col-md-6">
                            <div class="feature-card">
                                <i class="bi bi-plus-circle"></i>
                                <h5>Create Your First Request</h5>
                                <p class="text-muted">Start by creating a new content request with all necessary
                                    details.</p>
                                <a href="#" class="btn btn-primary mt-3 show-new-request">New Request</a>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="feature-card">
                                <i class="bi bi-file-earmark-text"></i>
                                <h5>Track Your Requests</h5>
                                <p class="text-muted">Monitor the status of your requests and see updates in real-time.
                                </p>
                                <a href="#" class="btn btn-outline-primary mt-3 view-my-requests">View Requests</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mt-4 fade-in">
                    <div class="col-lg-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-2">
                                    <a href="#" class="btn btn-primary show-new-request">
                                        <i class="bi bi-plus-circle me-2"></i>
                                        Create Your First Request
                                    </a>
                                    <a href="#" class="btn btn-outline-primary" id="tourBtn">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Take a Tour
                                    </a>
                                    <button class="btn btn-outline-secondary" id="refreshDashboardBtn">
                                        <i class="bi bi-arrow-clockwise me-2"></i>
                                        Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Existing User View (With Data) -->
            <div id="existingUserView" style="display: none;">
                <!-- Welcome Banner -->
                <div class="welcome-banner fade-in">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h1 id="welcomeMessage">Welcome back!</h1>
                            <p>You have <strong id="pendingRequestsCount">0 pending requests</strong> and <strong
                                    id="dueTodayCount">0 requests due today</strong>.</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="bg-white text-dark rounded-pill px-3 py-2 d-inline-block">
                                <i class="bi bi-calendar-check me-2"></i>
                                <span id="currentTime2"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3 fade-in">
                        <div class="stats-card" id="totalRequestsCard">
                            <i class="bi bi-file-earmark-text"></i>
                            <h3 class="count" id="totalRequestsCount">0</h3>
                            <p class="label">Total Requests</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 fade-in">
                        <div class="stats-card" id="pendingCard">
                            <i class="bi bi-hourglass-split"></i>
                            <h3 class="count" id="pendingCount">0</h3>
                            <p class="label">Pending</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 fade-in">
                        <div class="stats-card" id="approvedCard">
                            <i class="bi bi-check-circle"></i>
                            <h3 class="count" id="approvedCount">0</h3>
                            <p class="label">Approved</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3 fade-in">
                        <div class="stats-card" id="rejectedCard">
                            <i class="bi bi-x-circle"></i>
                            <h3 class="count" id="rejectedCount">0</h3>
                            <p class="label">Rejected</p>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Recent Requests -->
                    <div class="col-lg-8 mb-4 fade-in">
                        <div class="dashboard-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">My Recent Requests</h5>
                                <a href="#" class="btn btn-sm btn-primary view-my-requests">
                                    View All
                                </a>
                            </div>
                            <div class="card-body">
                                <div id="recentRequestsContent">
                                    <!-- Content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="col-lg-4 mb-4 fade-in">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="mb-0">Request Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="dashboardChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mt-4 fade-in">
                    <div class="col-lg-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5 class="mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-2">
                                    <a href="#" class="btn btn-primary show-new-request">
                                        <i class="bi bi-plus-circle me-2"></i>
                                        Create New Request
                                    </a>
                                    <a href="#" class="btn btn-outline-primary view-my-requests">
                                        <i class="bi bi-list-check me-2"></i>
                                        View My Requests
                                    </a>
                                    <button class="btn btn-outline-secondary" id="refreshDashboardBtn2">
                                        <i class="bi bi-arrow-clockwise me-2"></i>
                                        Refresh Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Requests View -->
            <div id="myRequestsView" style="display: none;">
                <div class="welcome-banner fade-in">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1>My Requests</h1>
                            <p>View and manage all your content requests in one place</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <button class="btn btn-primary back-to-dashboard-btn">
                                    <i class="bi bi-arrow-left me-2"></i> Back to Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="requests-filter fade-in">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="draft">Draft</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="all">All Categories</option>
                                <option value="breaking_news">Breaking News</option>
                                <option value="sports">Sports</option>
                                <option value="politics">Politics</option>
                                <option value="culture">Culture</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="business">Business</option>
                                <option value="health">Health</option>
                                <option value="education">Education</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Sort By</label>
                            <select class="form-select" id="sortFilter">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="date">Date</option>
                                <option value="priority">Priority</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" id="applyFiltersBtn">
                                    <i class="bi bi-filter me-2"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" id="clearFiltersBtn">
                                    <i class="bi bi-x-circle me-2"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Requests List -->
                <div id="requestsListContainer">
                    <!-- Requests will be loaded here -->
                </div>
            </div>

            <!-- New Request Form -->
            <div id="newRequestView" style="display: none;">
                <!-- Progress Steps -->
                <div class="progress-steps fade-in">
                    <div class="progress-step active">
                        <div class="step-icon">
                            <i class="bi bi-info-circle"></i>
                        </div>
                        <div class="step-label">Basic Information</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-icon">
                            <i class="bi bi-calendar"></i>
                        </div>
                        <div class="step-label">Schedule & Details</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-icon">
                            <i class="bi bi-upload"></i>
                        </div>
                        <div class="step-label">Upload Documents</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="step-label">Review & Submit</div>
                    </div>
                </div>

                <div class="form-section fade-in">
                    <div class="form-header">
                        <h2>Create New Coverage Request</h2>
                        <p>Fill in the details below to request media coverage for your event or story</p>
                    </div>

                    <form id="coverageRequestForm">
                        <!-- Step 1: Basic Information -->
                        <div class="mb-4">
                            <h4 class="mb-3" style="color: var(--secondary-color);">
                                <i class="bi bi-info-circle me-2"></i>Basic Information
                            </h4>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="requestTitle" class="form-label required">
                                            <i class="bi bi-card-heading"></i>Request Title
                                        </label>
                                        <input type="text" class="form-control" id="requestTitle"
                                            placeholder="Enter a descriptive title" required>
                                        <small class="text-muted mt-1 d-block">Briefly describe what you need coverage
                                            for</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="requestCategory" class="form-label required">
                                            <i class="bi bi-tags"></i>Category
                                        </label>
                                        <select class="form-select" id="requestCategory" required>
                                            <option value="">Select Category</option>
                                            <option value="breaking_news">Breaking News</option>
                                            <option value="sports">Sports</option>
                                            <option value="politics">Politics</option>
                                            <option value="culture">Culture</option>
                                            <option value="entertainment">Entertainment</option>
                                            <option value="business">Business</option>
                                            <option value="health">Health</option>
                                            <option value="education">Education</option>
                                            <option value="other">Other (Please specify)</option>
                                        </select>
                                        <div id="otherCategoryContainer" class="other-category-container">
                                            <input type="text" class="form-control mt-2" id="otherCategoryInput"
                                                placeholder="Enter your custom category">
                                            <small class="text-muted mt-1 d-block">Enter a custom category if not listed
                                                above</small>
                                        </div>
                                        <div id="selectedCategories" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="requestDescription" class="form-label required">
                                    <i class="bi bi-text-paragraph"></i>Description
                                </label>
                                <textarea class="form-control" id="requestDescription" rows="4"
                                    placeholder="Describe your coverage request in detail..." required></textarea>
                                <small class="text-muted mt-1 d-block">Provide comprehensive details about what needs
                                    coverage</small>
                            </div>
                        </div>

                        <!-- Step 2: Schedule & Details -->
                        <div class="mb-4">
                            <h4 class="mb-3" style="color: var(--secondary-color);">
                                <i class="bi bi-calendar me-2"></i>Schedule & Details
                            </h4>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="coverageDate" class="form-label required">
                                            <i class="bi bi-calendar-date"></i>Coverage Date
                                        </label>
                                        <input type="date" class="form-control" id="coverageDate" required>
                                        <small class="text-muted mt-1 d-block">When do you need the coverage?</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="requestPriority" class="form-label">
                                            <i class="bi bi-flag"></i>Priority
                                        </label>
                                        <select class="form-select" id="requestPriority">
                                            <option value="low">Low Priority</option>
                                            <option value="medium" selected>Medium Priority</option>
                                            <option value="high">High Priority</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="location" class="form-label">
                                    <i class="bi bi-geo-alt"></i>Location
                                </label>
                                <input type="text" class="form-control" id="location"
                                    placeholder="Enter coverage location or venue">
                                <small class="text-muted mt-1 d-block">Where will the coverage take place?</small>
                            </div>
                        </div>

                        <!-- Step 3: Upload Documents -->
                        <div class="mb-4">
                            <h4 class="mb-3" style="color: var(--secondary-color);">
                                <i class="bi bi-upload me-2"></i>Required Documents
                            </h4>
                            <p class="text-muted mb-3">Please upload the required documents for verification</p>

                            <div class="row g-3">
                                <!-- National ID Upload -->
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label required">
                                            <i class="bi bi-person-badge"></i>National ID
                                        </label>
                                        <div class="file-upload-area" id="nationalIdArea">
                                            <div class="file-upload-icon">
                                                <i class="bi bi-cloud-arrow-up"></i>
                                            </div>
                                            <div class="file-upload-text">
                                                <h5>Upload National ID</h5>
                                                <p>PDF, JPG, PNG (Max: 10MB)</p>
                                            </div>
                                            <input type="file" class="d-none" id="nationalIdFile"
                                                accept=".pdf,.jpg,.jpeg,.png" required>
                                            <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                                                onclick="document.getElementById('nationalIdFile').click()">
                                                <i class="bi bi-upload me-1"></i>Browse
                                            </button>
                                        </div>
                                        <div id="nationalIdPreview" class="file-preview" style="display: none;"></div>
                                    </div>
                                </div>

                                <!-- Trading License Upload -->
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label required">
                                            <i class="bi bi-file-earmark-text"></i>Trading License
                                        </label>
                                        <div class="file-upload-area" id="tradingLicenseArea">
                                            <div class="file-upload-icon">
                                                <i class="bi bi-cloud-arrow-up"></i>
                                            </div>
                                            <div class="file-upload-text">
                                                <h5>Upload Trading License</h5>
                                                <p>PDF, JPG, PNG (Max: 10MB)</p>
                                            </div>
                                            <input type="file" class="d-none" id="tradingLicenseFile"
                                                accept=".pdf,.jpg,.jpeg,.png" required>
                                            <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                                                onclick="document.getElementById('tradingLicenseFile').click()">
                                                <i class="bi bi-upload me-1"></i>Browse
                                            </button>
                                        </div>
                                        <div id="tradingLicensePreview" class="file-preview" style="display: none;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Proposal Document Upload -->
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label required">
                                            <i class="bi bi-file-earmark-ppt"></i>Proposal Document
                                        </label>
                                        <div class="file-upload-area" id="proposalArea">
                                            <div class="file-upload-icon">
                                                <i class="bi bi-cloud-arrow-up"></i>
                                            </div>
                                            <div class="file-upload-text">
                                                <h5>Upload Proposal</h5>
                                                <p>PDF, DOC, DOCX (Max: 20MB)</p>
                                            </div>
                                            <input type="file" class="d-none" id="proposalFile" accept=".pdf,.doc,.docx"
                                                required>
                                            <button type="button" class="btn btn-outline-primary btn-sm mt-2"
                                                onclick="document.getElementById('proposalFile').click()">
                                                <i class="bi bi-upload me-1"></i>Browse
                                            </button>
                                        </div>
                                        <div id="proposalPreview" class="file-preview" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Additional Information -->
                        <div class="mb-4">
                            <h4 class="mb-3" style="color: var(--secondary-color);">
                                <i class="bi bi-chat-left-text me-2"></i>Additional Information
                            </h4>

                            <div class="mb-3">
                                <label for="additionalNotes" class="form-label">
                                    <i class="bi bi-sticky"></i>Additional Notes
                                </label>
                                <textarea class="form-control" id="additionalNotes" rows="3"
                                    placeholder="Any additional information or special requirements..."></textarea>
                                <small class="text-muted mt-1 d-block">Add any extra details that might help us
                                    understand your request better</small>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline-secondary cancel-btn">
                                <i class="bi bi-x-circle me-2"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary ms-auto">
                                <i class="bi bi-check-circle me-2"></i>Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        class RequesterDashboard {
            constructor() {
                this.data = {
                    user: null,
                    requests: []
                };
                this.isNewUser = true;
                this.dateTimeInterval = null;
                this.currentView = 'dashboard';
                this.filters = {
                    status: 'all',
                    category: 'all',
                    sort: 'newest'
                };
                this.charts = {
                    dashboard: null
                };
                this.sessionTimeout = null;
                this.sessionWarningTimeout = null;
                this.currentStep = 1;
                this.customCategories = [];
            }

            init() {
                // Auto login as default user
                this.loginAsDefault();
                this.setupEventListeners();
                this.updateDateTime();
                this.setupFileUploads();
                this.setupForm();
                this.setupCategoryHandling();
                 // Add this line for automatic refresh every 30 seconds
  
                   this.fixOldRequests();
                   setTimeout(() => this.checkAndUpdateCompletedRequests(), 1000);
            }
async checkAndUpdateCompletedRequests() {
    try {
        console.log('Checking for completed requests...');
        
        // Get all request IDs that should be checked
        const requestIds = this.data.requests
            .map(req => req.id || req._id)
            .filter(id => id && !id.startsWith('req_')); // Only check real server IDs
        
        if (requestIds.length === 0) {
            console.log('No server requests to check');
            return;
        }
        
        // Check each request's status from server
        for (const requestId of requestIds) {
            try {
                const response = await fetch(`http://localhost:5001/api/requests/${requestId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const serverStatus = result.data.status || result.data.currentStatus;
                        
                        // Find the request in our data
                        const localRequest = this.data.requests.find(r => 
                            (r.id === requestId) || (r._id === requestId)
                        );
                        
                        if (localRequest && localRequest.status !== serverStatus) {
                            console.log(`Updating "${localRequest.title}" from "${localRequest.status}" to "${serverStatus}"`);
                            
                            // Update local data
                            localRequest.status = serverStatus;
                            
                            // If server says completed, update immediately
                            if (serverStatus === 'completed') {
                                // Update UI right away
                                this.updateDashboardStats();
                                if (this.currentView === 'myRequests') {
                                    this.renderMyRequests();
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn(`Could not check request ${requestId}:`, error);
            }
        }
        
    } catch (error) {
        console.error('Error checking completed requests:', error);
    }
}
           loginAsDefault() {
    // Try to get real user data from localStorage/auth
    const storedUser = JSON.parse(localStorage.getItem('userSession') || '{}');
    const authToken = localStorage.getItem('authToken');

    // Create default user data - USE THE ACTUAL USER EMAIL
   // Create default user data - USE THE ACTUAL USER EMAIL
const userEmail = storedUser.email || 'requester@amedia.et'; // <-- Changed from editor@amedia.et to requester@amedia.et
    
    const defaultUser = {
        name: storedUser.name || 'Content Requester',
        email: userEmail,  // <-- Use the real email here
        avatar: storedUser.avatar || 'RQ',
        role: storedUser.role || 'requester'
    };

    console.log('Logging in as user:', defaultUser.email);

    // Rest of the method stays the same...
    // Set user data
    this.data.user = defaultUser;

    // Save user to localStorage
    localStorage.setItem('currentUser', JSON.stringify(defaultUser));

    // Load user's requests
    this.loadUserRequests();

    // Update UI
    this.updateUserUI();

    // Determine view based on requests
    this.determineUserView();

    // Show dashboard
    this.showView('dashboard');

    // Start session timer
    this.startSessionTimer();
}
logout() {
    if (confirm('Are you sure you want to logout?')) {
        // Clear all user data
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userSession');
        localStorage.removeItem('authToken');

        // Clear session timers
        if (this.sessionTimeout) {
            clearTimeout(this.sessionTimeout);
        }
        if (this.sessionWarningTimeout) {
            clearTimeout(this.sessionWarningTimeout);
        }

        // Show logout message
        alert('You have been logged out successfully.');

        // Redirect to login page - Use one of these options:
        // Option 1: If login.html is in the same directory
        window.location.href = 'login.html';
        
        // Option 2: If it's in the root directory
        // window.location.href = '../login.html';
        
        // Option 3: If you want to go to the main login page
        // window.location.href = window.location.origin + '/login.html';
    }
}
async loadUserRequests() {
    try {
        const token = localStorage.getItem('authToken');
        
        if (!token) {
            console.log('No auth token available');
            return;
        }

        // Use the SAME API endpoint as editor dashboard
        const response = await fetch('http://localhost:5001/api/requests', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.data) {
                // Filter requests for current user
                const userRequests = result.data.filter(request => 
                    (request.submitterEmail || '').toLowerCase() === this.data.user.email.toLowerCase()
                );
                
                console.log(` Found ${userRequests.length} requests from server for ${this.data.user.email}`);
                
                // Process the filtered requests
                this.processApiRequests(userRequests);
                
                // Update UI
                this.updateDashboardStats();
                if (this.currentView === 'dashboard') {
                    this.renderRecentRequests();
                }
                
                return;
            }
        }
        
        // Fallback to localStorage
        console.log('Server fetch failed, using localStorage');
        this.loadFromLocalStorage();
        
    } catch (error) {
        console.error('Network error:', error);
        this.loadFromLocalStorage();
    }
}
// Add this new method to check for status changes
checkForStatusUpdates() {
    const completedRequests = this.data.requests.filter(r => r.status === 'completed');
    
    if (completedRequests.length > 0) {
        console.log(` Found ${completedRequests.length} completed requests`);
        
        // Show notification to user
        this.showNotification(
            `${completedRequests.length} request${completedRequests.length > 1 ? 's' : ''} have been completed!`
        );
        
        // Force UI refresh
        if (this.currentView === 'dashboard') {
            this.loadDashboardData();
        }
    }
}
// Add this notification method
showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'position-fixed top-0 end-0 p-3';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>
                <strong class="me-auto">Status Update</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="dashboard.loadUserRequests()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh Now
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 10 seconds
    setTimeout(() => {
        notification.remove();
    }, 10000);
}

saveRequestToLocalStorage(requestData) {
    console.log('Saving request to localStorage:', requestData);
    
    // Get existing requests
    const allRequests = JSON.parse(localStorage.getItem('coverageRequests') || '[]');
    
    // Add new request
    allRequests.push(requestData);
    
    // Save back to localStorage
    localStorage.setItem('coverageRequests', JSON.stringify(allRequests));
    
    // Update dashboard data
    this.data.requests.push(requestData);
    this.isNewUser = false;
    
    console.log('Request saved successfully to localStorage');
}
fixOldRequests() {
    console.log('Fixing old requests with correct email...');
    
    const allRequests = JSON.parse(localStorage.getItem('coverageRequests') || '[]');
    const userEmail = this.data.user.email;
    
    let updated = false;
    
    // Update all old requests to use current user's email
    allRequests.forEach(request => {
        if (request.submitterEmail === 'requester@amc.et' || !request.submitterEmail) {
            request.submitterEmail = userEmail;
            updated = true;
            console.log('Updated request:', request.title, 'with email:', userEmail);
        }
    });
    
    if (updated) {
        localStorage.setItem('coverageRequests', JSON.stringify(allRequests));
        console.log('Updated old requests with correct email:', userEmail);
        
        // Reload requests
        this.loadUserRequests();
    } else {
        console.log('No old requests needed fixing');
    }
}
async loadFromLocalStorage() {
    console.log('Loading requests from localStorage');
    const allRequests = JSON.parse(localStorage.getItem('coverageRequests') || '[]');
    
    console.log('All requests in localStorage:', allRequests);
    console.log('Current user email:', this.data.user?.email);

    // Filter requests for current user
    if (this.data.user && this.data.user.email) {
        this.data.requests = allRequests.filter(request => {
            const requestEmail = request.submitterEmail || request.submittedByEmail || request.email || '';
            const userEmail = this.data.user.email.toLowerCase();
            
            return requestEmail.toLowerCase() === userEmail;
        });
        console.log('Found', this.data.requests.length, 'requests for user', this.data.user.email);
    } else {
        this.data.requests = [];
        console.log('No user email found, returning empty requests');
    }

    // =========== CRITICAL FIX: UPDATE STATUS FROM SERVER ===========
    // Use Promise.all to wait for all status updates
    const statusUpdatePromises = this.data.requests.map(async (request, index) => {
        try {
            const requestId = request.id || request._id;
            if (!requestId || requestId.startsWith('req_')) {
                return null; // Local request, skip
            }

            const token = localStorage.getItem('authToken');
            if (!token) {
                console.log('No auth token available for status update');
                return null;
            }

            // Fetch latest status from server
            const response = await fetch(`http://localhost:5001/api/requests/${requestId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    const serverStatus = result.data.status || result.data.currentStatus;
                    
                    console.log(`Server status for ${requestId}: ${serverStatus}, Local: ${request.status}`);
                    
                    if (serverStatus !== request.status) {
                        // Update local request with server status
                        this.data.requests[index].status = serverStatus;
                        
                        // Also update localStorage
                        this.updateLocalStorageRequest(requestId, {
                            status: serverStatus,
                            assignedReporter: result.data.assignedReporter,
                            editorNotes: result.data.editorNotes
                        });
                        
                        return { requestId, oldStatus: request.status, newStatus: serverStatus };
                    }
                }
            }
        } catch (error) {
            console.warn(`Could not fetch status for request ${request.id}:`, error);
        }
        return null;
    });

    // Wait for all status updates to complete
    const statusUpdates = await Promise.all(statusUpdatePromises);
    const updatedRequests = statusUpdates.filter(update => update !== null);
    
    if (updatedRequests.length > 0) {
        console.log('Updated statuses:', updatedRequests);
        
        // Force UI update after status updates
        setTimeout(() => {
            if (this.currentView === 'dashboard') {
                this.loadDashboardData();
            } else if (this.currentView === 'myRequests') {
                this.renderMyRequests();
            }
        }, 500);
    }
    // =========== END FIX ===========

    // Convert string dates to Date objects
    this.data.requests.forEach(request => {
        if (typeof request.submittedAt === 'string') {
            request.submittedAt = new Date(request.submittedAt);
        }
        if (typeof request.createdAt === 'string') {
            request.createdAt = new Date(request.createdAt);
        }
        if (typeof request.date === 'string') {
            request.date = new Date(request.date);
        }
        // Ensure request has an ID
        if (!request.id) {
            request.id = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
    });

    // Check if user has any requests
    if (this.data.requests.length > 0) {
        this.isNewUser = false;
        console.log('User is NOT new (has requests)');
    } else {
        console.log('User is new (no requests)');
    }
}
updateLocalStorageRequest(requestId, updates) {
    try {
        const allRequests = JSON.parse(localStorage.getItem('coverageRequests') || '[]');
        const index = allRequests.findIndex(r => r.id === requestId || r._id === requestId);
        
        if (index !== -1) {
            allRequests[index] = { ...allRequests[index], ...updates };
            localStorage.setItem('coverageRequests', JSON.stringify(allRequests));
            console.log(`Updated localStorage for request ${requestId}:`, updates);
        }
    } catch (error) {
        console.error('Error updating localStorage:', error);
    }
}

processApiRequests(apiRequests) {
    console.log('Processing API requests:', apiRequests.length);
    
    // Simple mapping - use EXACT status from server
    this.data.requests = apiRequests.map(request => ({
        id: request._id || request.id,
        title: request.title || 'Untitled Request',
        category: request.category || 'general',
        description: request.description || '',
        date: request.date ? new Date(request.date) : null,
        priority: request.priority || 'medium',
        location: request.address || request.location || '',
        notes: request.additionalInfo || '',
        status: request.status || 'pending', // Use EXACT status from server
        submitterEmail: request.submitterEmail || this.data.user.email,
        submitterName: request.submittedBy || this.data.user.name,
        submittedAt: request.createdAt ? new Date(request.createdAt) : new Date(),
        createdAt: request.createdAt ? new Date(request.createdAt) : new Date()
    }));

    console.log('Status check:', this.data.requests.map(r => ({ title: r.title, status: r.status })));
    
    // Check if user has any requests
    if (this.data.requests.length > 0) {
        this.isNewUser = false;
    }
}

            saveUserRequests() {
                // Get all existing requests
                const allRequests = JSON.parse(localStorage.getItem('coverageRequests') || '[]');

                // Filter out current user's old requests
                const otherRequests = allRequests.filter(request =>
                    !this.data.requests.some(userReq => userReq.id === request.id)
                );

                // Add current user's requests
                const updatedRequests = [...otherRequests, ...this.data.requests];

                // Save back to localStorage
                localStorage.setItem('coverageRequests', JSON.stringify(updatedRequests));
            }

            determineUserView() {
                if (this.isNewUser) {
                    this.showNewUserView();
                } else {
                    this.showExistingUserView();
                    this.loadDashboardData();
                }
            }

            showNewUserView() {
                document.getElementById('newUserView').style.display = 'block';
                document.getElementById('existingUserView').style.display = 'none';

                if (this.data.user) {
                    document.getElementById('welcomeMessageNew').textContent =
                        `Welcome to AMC, ${this.data.user.name.split(' ')[0]}!`;
                }

                document.getElementById('requestsBadge').textContent = '0';
            }

            showExistingUserView() {
                document.getElementById('newUserView').style.display = 'none';
                document.getElementById('existingUserView').style.display = 'block';
            }

            updateUserUI() {
                const user = this.data.user;
                if (!user) return;

                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').textContent = user.avatar;
                document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.name.split(' ')[0]}!`;
              document.getElementById('userRoleBadge').textContent = 'REQUESTS';
            }

            loadDashboardData() {
                this.updateDashboardStats();
                this.renderRecentRequests();
                this.initDashboardChart();

                // Update badge in sidebar
                document.getElementById('requestsBadge').textContent = this.data.requests.length;
            }

            updateDashboardStats() {
                const total = this.data.requests.length;
                const pending = this.data.requests.filter(r => r.status === 'pending').length;
                const approved = this.data.requests.filter(r => r.status === 'approved').length;
                const rejected = this.data.requests.filter(r => r.status === 'rejected').length;

                // Count requests due today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueToday = this.data.requests.filter(request => {
                    if (!request.date) return false;
                    const dueDate = new Date(request.date);
                    dueDate.setHours(0, 0, 0, 0);
                    return dueDate.getTime() === today.getTime();
                }).length;

                // Update UI
                document.getElementById('totalRequestsCount').textContent = total;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('approvedCount').textContent = approved;
                document.getElementById('rejectedCount').textContent = rejected;

                document.getElementById('pendingRequestsCount').textContent = `${pending} pending request${pending !== 1 ? 's' : ''}`;
                document.getElementById('dueTodayCount').textContent = `${dueToday} request${dueToday !== 1 ? 's' : ''} due today`;

                // Update notifications badge
                document.getElementById('notificationCount').textContent = pending;
                document.getElementById('requestsBadge').textContent = total;
            }

            renderRecentRequests() {
                const container = document.getElementById('recentRequestsContent');

                if (this.data.requests.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-file-earmark-text"></i>
                            <h4>No Requests Yet</h4>
                            <p>You haven't created any content requests yet. Start by creating your first request!</p>
                            <a href="#" class="btn btn-primary show-new-request">
                                <i class="bi bi-plus-circle me-2"></i>
                                Create Your First Request
                            </a>
                        </div>
                    `;
                    return;
                }

                // Sort by date (newest first) and get top 5
                const recentRequests = [...this.data.requests]
                    .sort((a, b) => {
                        const dateA = a.submittedAt || a.createdAt || new Date(0);
                        const dateB = b.submittedAt || b.createdAt || new Date(0);
                        return new Date(dateB) - new Date(dateA);
                    })
                    .slice(0, 5);

                let tableHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                recentRequests.forEach(request => {
                    const date = request.submittedAt || request.createdAt || new Date();
                    const dateStr = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    const statusClass = `status-${request.status || 'pending'}`;
                    const statusText = (request.status || 'pending').charAt(0).toUpperCase() +
                        (request.status || 'pending').slice(1).replace('_', ' ');

                    tableHTML += `
                        <tr>
                            <td>
                                <strong>${request.title || 'Untitled Request'}</strong>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">${request.category || 'Uncategorized'}</span>
                            </td>
                            <td>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </td>
                            <td>
                                <small class="text-muted">${dateStr}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-request-btn" data-id="${request.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = tableHTML;

                // Add event listeners to view buttons
                container.querySelectorAll('.view-request-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const requestId = e.target.closest('button').getAttribute('data-id');
                        this.viewRequestDetails(requestId);
                    });
                });
            }

            initDashboardChart() {
                const ctx = document.getElementById('dashboardChart');
                if (!ctx) return;

                // Destroy existing chart
                if (this.charts.dashboard) {
                    this.charts.dashboard.destroy();
                }

                // Get status counts
                const statusCounts = {
                    pending: this.data.requests.filter(r => r.status === 'pending').length,
                    approved: this.data.requests.filter(r => r.status === 'approved').length,
                    rejected: this.data.requests.filter(r => r.status === 'rejected').length,
                    draft: this.data.requests.filter(r => r.status === 'draft').length,
                    'in-progress': this.data.requests.filter(r => r.status === 'in-progress').length,
                    completed: this.data.requests.filter(r => r.status === 'completed').length
                };

                // Filter out zero values
                const labels = [];
                const data = [];
                const colors = [];

                Object.entries(statusCounts).forEach(([status, count]) => {
                    if (count > 0) {
                        labels.push(status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' '));
                        data.push(count);
                        colors.push(this.getStatusColor(status));
                    }
                });

                this.charts.dashboard = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            }

            getStatusColor(status) {
    const colors = {
        'pending': '#ffc107',
        'approved': '#28a745',
        'rejected': '#dc3545',
        'draft': '#6c757d',
        'in-progress': '#17a2b8',
        'in_progress': '#17a2b8', // ADD THIS
        'completed': '#20c997'    // MAKE SURE THIS EXISTS
    };
    return colors[status] || '#6c757d';
}

            viewRequestDetails(requestId) {
    const request = this.data.requests.find(r => r.id === requestId);
    if (!request) {
        alert('Request not found!');
        return;
    }

    const modalBody = document.getElementById('requestModalBody');

    if (!modalBody) {
        console.error('Modal elements not found');
        return;
    }

    const status = request.status || 'pending';
const statusClass = `status-${request.status || 'pending'}`;
let statusText = (request.status || 'pending').charAt(0).toUpperCase() +
    (request.status || 'pending').slice(1).replace('_', ' ');
if (status === 'in_progress') {
    statusText = 'In Progress';
} else if (status === 'completed') {
    statusText = 'Completed';
}
    const dateStr = request.submittedAt ?
        request.submittedAt.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }) : 'Not submitted';

    // =========== ADD THIS SECTION ===========
    // Check if request has editor feedback/notes (for in_progress status)
    let editorFeedbackHTML = '';
    if (request.status === 'in_progress' && request.editorNotes) {
        editorFeedbackHTML = `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-white">
                            <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Revision Required</h6>
                        </div>
                        <div class="card-body">
                            <h6 class="mb-2">Editor's Feedback:</h6>
                            <div class="alert alert-warning">
                                <i class="bi bi-chat-left-text me-2"></i>
                                ${request.editorNotes}
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Please update your request based on the editor's feedback and resubmit.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Also show assigned reporter if available
    let assignedReporterHTML = '';
    if (request.assignedReporter) {
        assignedReporterHTML = `
            <div class="detail-item mb-2">
                <span class="detail-label">Assigned Reporter</span>
                <span class="detail-value">
                    ${request.assignedReporter.name || 'Not assigned'}
                    ${request.assignedReporter.email ? `<br><small class="text-muted">${request.assignedReporter.email}</small>` : ''}
                </span>
            </div>
        `;
    }
    // =========== END OF NEW SECTION ===========

    // Show uploaded files if available
    let filesHTML = '';
    if (request.files) {
        filesHTML = `
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Uploaded Documents</h6>
                    <div class="file-preview">
                        ${request.files.nationalId ?
                            `<div class="file-item">
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                    <div class="file-details">
                                        <div class="file-name">National ID</div>
                                        <div class="file-size">${request.files.nationalId}</div>
                                    </div>
                                </div>
                            </div>` : ''}
                        ${request.files.tradingLicense ?
                            `<div class="file-item">
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="bi bi-file-earmark-text"></i>
                                    </div>
                                    <div class="file-details">
                                        <div class="file-name">Trading License</div>
                                        <div class="file-size">${request.files.tradingLicense}</div>
                                    </div>
                                </div>
                            </div>` : ''}
                        ${request.files.proposal ?
                            `<div class="file-item">
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="bi bi-file-earmark-ppt"></i>
                                    </div>
                                    <div class="file-details">
                                        <div class="file-name">Proposal Document</div>
                                        <div class="file-size">${request.files.proposal}</div>
                                    </div>
                                </div>
                            </div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <h6>Description</h6>
                    <p class="p-3 bg-light rounded">${request.description || 'No description provided'}</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <h6>Details</h6>
                    <div class="detail-item mb-2">
                        <span class="detail-label">Status</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="detail-item mb-2">
                        <span class="detail-label">Category</span>
                        <span class="detail-value">${request.category || 'Uncategorized'}</span>
                    </div>
                    <div class="detail-item mb-2">
                        <span class="detail-label">Priority</span>
                        <span class="detail-value">${request.priority || 'Medium'}</span>
                    </div>
                    <div class="detail-item mb-2">
                        <span class="detail-label">Location</span>
                        <span class="detail-value">${request.location || 'Not specified'}</span>
                    </div>
                    ${assignedReporterHTML}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="detail-item">
                    <span class="detail-label">Submitted Date</span>
                    <span class="detail-value">${dateStr}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="detail-item">
                    <span class="detail-label">Coverage Date</span>
                    <span class="detail-value">${request.date ? new Date(request.date).toLocaleDateString() : 'Not specified'}</span>
                </div>
            </div>
        </div>
        ${request.notes ? `
        <div class="row mt-3">
            <div class="col-12">
                <div class="mb-3">
                    <h6>Additional Notes</h6>
                    <p class="p-3 bg-light rounded">${request.notes}</p>
                </div>
            </div>
        </div>
        ` : ''}
        ${editorFeedbackHTML}
        ${filesHTML}
    `;

    const modal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
    modal.show();
}

            showView(viewName) {
                this.currentView = viewName;

                // Hide all views
                ['newUserView', 'existingUserView', 'myRequestsView', 'newRequestView'].forEach(viewId => {
                    document.getElementById(viewId).style.display = 'none';
                });

                // Update page title
                const titles = {
                    'dashboard': 'Content Requester Dashboard',
                    'myRequests': 'My Requests',
                    'newRequest': 'New Coverage Request'
                };

                document.getElementById('pageTitle').textContent = titles[viewName] || titles.dashboard;

                // Show selected view
                switch (viewName) {
                    case 'dashboard':
                        if (this.isNewUser) {
                            document.getElementById('newUserView').style.display = 'block';
                        } else {
                            document.getElementById('existingUserView').style.display = 'block';
                            this.loadDashboardData();
                        }
                        break;
                    case 'myRequests':
                        document.getElementById('myRequestsView').style.display = 'block';
                        this.renderMyRequests();
                        break;
                    case 'newRequest':
                        document.getElementById('newRequestView').style.display = 'block';
                        // Set today's date as default
                        const today = new Date().toISOString().split('T')[0];
                        document.getElementById('coverageDate').value = today;
                        // Reset form
                        this.resetForm();
                        // Update progress steps
                        this.updateProgressSteps();
                        break;
                }

                // Update sidebar active state
                this.updateSidebarActiveState(viewName);

                // Reset session timer on user activity
                this.resetSessionTimer();

                // Trigger fade-in animations
                setTimeout(() => {
                    const fadeElements = document.querySelectorAll(`#${viewName}View .fade-in`);
                    fadeElements.forEach((el, index) => {
                        el.style.animationDelay = `${index * 0.1}s`;
                    });
                }, 100);
            }

            updateProgressSteps() {
                const steps = document.querySelectorAll('.progress-step');
                steps.forEach((step, index) => {
                    if (index < this.currentStep) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
            }

            updateSidebarActiveState(viewName) {
                const navLinks = document.querySelectorAll('.sidebar-menu .nav-link');
                navLinks.forEach(link => link.classList.remove('active'));

                switch (viewName) {
                    case 'dashboard':
                        document.getElementById('dashboardLink').classList.add('active');
                        break;
                    case 'myRequests':
                        document.getElementById('myRequestsLink').classList.add('active');
                        break;
                    case 'newRequest':
                        document.getElementById('newRequestLink').classList.add('active');
                        break;
                }
            }

            // Category handling
            setupCategoryHandling() {
                const categorySelect = document.getElementById('requestCategory');
                const otherCategoryContainer = document.getElementById('otherCategoryContainer');
                const otherCategoryInput = document.getElementById('otherCategoryInput');
                const selectedCategoriesContainer = document.getElementById('selectedCategories');

                if (categorySelect) {
                    categorySelect.addEventListener('change', (e) => {
                        if (e.target.value === 'other') {
                            otherCategoryContainer.style.display = 'block';
                            otherCategoryInput.focus();
                        } else {
                            otherCategoryContainer.style.display = 'none';
                        }
                    });
                }

                if (otherCategoryInput) {
                    otherCategoryInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addCustomCategory();
                        }
                    });

                    otherCategoryInput.addEventListener('blur', () => {
                        this.addCustomCategory();
                    });
                }
            }

            addCustomCategory() {
                const otherCategoryInput = document.getElementById('otherCategoryInput');
                const selectedCategoriesContainer = document.getElementById('selectedCategories');
                const categorySelect = document.getElementById('requestCategory');

                if (otherCategoryInput.value.trim()) {
                    const category = otherCategoryInput.value.trim();

                    // Add to custom categories array if not already present
                    if (!this.customCategories.includes(category)) {
                        this.customCategories.push(category);
                    }

                    // Update selected categories display
                    this.updateSelectedCategories();

                    // Reset input
                    otherCategoryInput.value = '';
                    categorySelect.value = '';
                }
            }

            removeCustomCategory(category) {
                const index = this.customCategories.indexOf(category);
                if (index > -1) {
                    this.customCategories.splice(index, 1);
                    this.updateSelectedCategories();
                }
            }

            updateSelectedCategories() {
                const selectedCategoriesContainer = document.getElementById('selectedCategories');

                if (this.customCategories.length > 0) {
                    let html = '<div class="d-flex flex-wrap gap-1 mb-2">';
                    this.customCategories.forEach(category => {
                        html += `
                            <span class="custom-category-chip">
                                ${category}
                                <i class="bi bi-x" onclick="dashboard.removeCustomCategory('${category}')"></i>
                            </span>
                        `;
                    });
                    html += '</div>';
                    selectedCategoriesContainer.innerHTML = html;
                } else {
                    selectedCategoriesContainer.innerHTML = '';
                }
            }

            // File upload setup
            setupFileUploads() {
                // Setup drag and drop for file upload areas
                const uploadAreas = ['nationalIdArea', 'tradingLicenseArea', 'proposalArea'];

                uploadAreas.forEach(areaId => {
                    const area = document.getElementById(areaId);
                    if (!area) return;

                    const fileInput = area.querySelector('input[type="file"]');
                    const previewId = areaId.replace('Area', 'Preview');

                    // Click handler
                    area.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                            fileInput.click();
                        }
                    });

                    // File change handler
                    fileInput.addEventListener('change', (e) => {
                        this.previewFile(e.target, previewId);
                    });

                    // Drag and drop handlers
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        area.addEventListener(eventName, (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    });

                    ['dragenter', 'dragover'].forEach(eventName => {
                        area.addEventListener(eventName, () => {
                            area.classList.add('drag-over');
                        });
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        area.addEventListener(eventName, () => {
                            area.classList.remove('drag-over');
                        });
                    });

                    // Drop handler
                    area.addEventListener('drop', (e) => {
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            fileInput.files = files;
                            this.previewFile(fileInput, previewId);
                        }
                    });
                });
            }

            previewFile(input, previewId) {
                const files = input.files;
                const preview = document.getElementById(previewId);

                if (files.length > 0) {
                    let previewHTML = '';

                    Array.from(files).forEach((file, index) => {
                        const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                        const fileName = file.name;
                        const fileType = file.type;

                        // Determine icon based on file type
                        let icon = 'bi-file-earmark';
                        if (fileType.includes('image')) icon = 'bi-file-image';
                        else if (fileType.includes('pdf')) icon = 'bi-file-pdf';
                        else if (fileType.includes('word') || fileType.includes('document')) icon = 'bi-file-word';

                        previewHTML += `
                            <div class="file-item" data-index="${index}">
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="bi ${icon}"></i>
                                    </div>
                                    <div class="file-details">
                                        <div class="file-name">${fileName}</div>
                                        <div class="file-size">${fileSize} MB</div>
                                    </div>
                                </div>
                                <button type="button" class="file-remove" onclick="dashboard.removeFile('${previewId}', ${index}, '${input.id}')">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        `;
                    });

                    preview.innerHTML = previewHTML;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            }

            removeFile(previewId, index, inputId) {
                const preview = document.getElementById(previewId);
                const fileItem = preview.querySelector(`[data-index="${index}"]`);
                const input = document.getElementById(inputId);

                if (fileItem) {
                    fileItem.remove();
                }

                // Remove file from input
                const dt = new DataTransfer();
                const files = Array.from(input.files);
                files.splice(index, 1);

                files.forEach(file => {
                    dt.items.add(file);
                });

                input.files = dt.files;

                // Hide preview if no files left
                if (files.length === 0) {
                    preview.style.display = 'none';
                }
            }

            // Form setup
            // Form setup
            // Form setup
            setupForm() {
                const form = document.getElementById('coverageRequestForm');
                if (form) {
                    form.addEventListener('submit', async (e) => {  // Add async here
                        e.preventDefault();
                        await this.submitNewRequest();  // Add await here
                    });
                }
            }

            resetForm() {
                const form = document.getElementById('coverageRequestForm');
                if (form) {
                    form.reset();
                }

                // Clear file previews
                ['nationalIdPreview', 'tradingLicensePreview', 'proposalPreview'].forEach(previewId => {
                    const preview = document.getElementById(previewId);
                    if (preview) {
                        preview.style.display = 'none';
                        preview.innerHTML = '';
                    }
                });

                // Reset file inputs
                ['nationalIdFile', 'tradingLicenseFile', 'proposalFile'].forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = '';
                    }
                });

                // Reset custom categories
                this.customCategories = [];
                this.updateSelectedCategories();

                // Hide other category input
                document.getElementById('otherCategoryContainer').style.display = 'none';

                // Reset progress steps
                this.currentStep = 1;
                this.updateProgressSteps();
            }

            // Replace the current form submission logic with this:

            async submitNewRequest() {
                // Get form values
                const title = document.getElementById('requestTitle').value;
                const categorySelect = document.getElementById('requestCategory');
                const otherCategory = document.getElementById('otherCategoryInput').value;
                const description = document.getElementById('requestDescription').value;
                const date = document.getElementById('coverageDate').value;
                const priority = document.getElementById('requestPriority').value;
                const location = document.getElementById('location').value;
                const additionalNotes = document.getElementById('additionalNotes').value;

                // Determine category
                let category = categorySelect.value;
                if (category === 'other' && otherCategory) {
                    category = otherCategory;
                }

                // Validate required fields
                if (!title || !category || !description || !date || !location) {
                    alert('Please fill all required fields');
                    return;
                }

                // Get files
                const nationalIdFile = document.getElementById('nationalIdFile').files[0];
                const tradingLicenseFile = document.getElementById('tradingLicenseFile').files[0];
                const proposalFile = document.getElementById('proposalFile').files[0];

                // Validate required files
                if (!nationalIdFile || !tradingLicenseFile || !proposalFile) {
                    alert('Please upload all required files');
                    return;
                }

                try {
                    // Create FormData and append ALL fields
                    const formData = new FormData();

                    // Append all required text fields
                    formData.append('title', title);
                    formData.append('category', category);
                    formData.append('description', description);
                    formData.append('date', date);
                    formData.append('priority', priority);
                    formData.append('address', location); // Note: backend expects 'address', not 'location'

                    // Append optional fields
                    if (additionalNotes) {
                        formData.append('additionalInfo', additionalNotes);
                    }

                 // Append user info (from your dashboard data)
formData.append('submitterEmail', this.data.user.email);
formData.append('submittedBy', this.data.user.name);
formData.append('submitterDepartment', 'news');

// ALSO SAVE TO LOCALSTORAGE WITH CORRECT EMAIL
const requestData = {
    id: 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    title: title,
    category: category,
    description: description,
    date: date,
    priority: priority,
    location: location,
    notes: additionalNotes,
    status: 'pending', // Default status
    submitterEmail: this.data.user.email, // <-- THIS IS CRITICAL!
    submitterName: this.data.user.name,
    submittedAt: new Date().toISOString(),
    createdAt: new Date().toISOString(),
    files: {
        nationalId: nationalIdFile ? nationalIdFile.name : 'No file',
        tradingLicense: tradingLicenseFile ? tradingLicenseFile.name : 'No file',
        proposal: proposalFile ? proposalFile.name : 'No file'
    }
};


// Save to localStorage immediately
this.saveRequestToLocalStorage(requestData);

                    // Append files
                    formData.append('nationalId', nationalIdFile);
                    formData.append('tradingLicense', tradingLicenseFile);
                    formData.append('proposal', proposalFile);

                    console.log(' FormData contents:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}:`, value instanceof File ? `${value.name} (${value.size} bytes)` : value);
                    }

                    // Get auth token
                    const token = localStorage.getItem('authToken');

                    // Send request with files
                    const response = await fetch('http://localhost:5001/api/requests', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // Don't set Content-Type - browser will set it automatically for FormData
                        },
                        body: formData
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || 'Unknown error');
                    }

                    this.showSuccessMessage();
                    this.resetForm();

                    // Reload requests
                    setTimeout(() => {
                        this.showView('dashboard');
                        this.loadUserRequests();
                    }, 2000);

                } catch (error) {
                    console.error('Submit error:', error);
                    alert('Failed to submit request: ' + error.message);
                }
            }
            showSuccessMessage() {
                // Create success overlay
                const successOverlay = document.createElement('div');
                successOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    opacity: 0;
                    animation: fadeIn 0.5s ease forwards;
                `;

                successOverlay.innerHTML = `
                    <div class="text-center text-white" style="animation: scaleIn 0.5s ease 0.3s both;">
                        <div class="mb-4" style="animation: float 2s ease-in-out infinite;">
                            <i class="bi bi-check-circle-fill" style="font-size: 4rem; color: #28a745;"></i>
                        </div>
                        <h2 class="mb-3" style="font-size: 1.8rem;">Request Submitted Successfully!</h2>
                        <p class="mb-4" style="font-size: 1.1rem; opacity: 0.9;">
                            Your coverage request has been submitted and is now under review.
                        </p>
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Redirecting to dashboard...</p>
                    </div>
                `;

                document.body.appendChild(successOverlay);

                // Add animation styles
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes scaleIn {
                        from { transform: scale(0.8); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);

                // Remove overlay after animation
                setTimeout(() => {
                    successOverlay.remove();
                    style.remove();
                }, 2500);
            }

           renderMyRequests() {
    const container = document.getElementById('requestsListContainer');
    
    console.log('=== RENDER MY REQUESTS DEBUG ===');
    console.log('Total requests:', this.data.requests.length);
    console.log('Requests data:', this.data.requests);

    if (this.data.requests.length === 0) {
        console.log('No requests found for this user');
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-file-earmark-text"></i>
                <h4>No Requests Yet</h4>
                <p>You haven't created any content requests yet. Start by creating your first request!</p>
                <p class="text-muted small mt-2">Debug: User email is ${this.data.user?.email || 'not found'}</p>
                <a href="#" class="btn btn-primary show-new-request">
                    <i class="bi bi-plus-circle me-2"></i>
                    Create Your First Request
                </a>
            </div>
        `;
        return;
    }

    // Filter requests
    let filteredRequests = [...this.data.requests];

    console.log('Before filtering:', filteredRequests.length);
    
    if (this.filters.status !== 'all') {
        filteredRequests = filteredRequests.filter(request => request.status === this.filters.status);
        console.log('After status filter:', filteredRequests.length);
    }

    if (this.filters.category !== 'all') {
        filteredRequests = filteredRequests.filter(request => request.category === this.filters.category);
        console.log('After category filter:', filteredRequests.length);
    }

    // Sort requests
    switch (this.filters.sort) {
        case 'newest':
            filteredRequests.sort((a, b) => new Date(b.submittedAt || b.createdAt) - new Date(a.submittedAt || a.createdAt));
            break;
        case 'oldest':
            filteredRequests.sort((a, b) => new Date(a.submittedAt || a.createdAt) - new Date(b.submittedAt || b.createdAt));
            break;
        case 'date':
            filteredRequests.sort((a, b) => new Date(a.date) - new Date(b.date));
            break;
        case 'priority':
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            filteredRequests.sort((a, b) => priorityOrder[b.priority || 'medium'] - priorityOrder[a.priority || 'medium']);
            break;
    }

    console.log('Final filtered requests:', filteredRequests.length);

    // Render requests
    let requestsHTML = '';

    filteredRequests.forEach((request, index) => {
        const date = request.submittedAt || request.createdAt || new Date();
        const dateStr = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });

        const statusClass = `status-${request.status || 'pending'}`;
        const statusText = (request.status || 'pending').charAt(0).toUpperCase() +
            (request.status || 'pending').slice(1).replace('_', ' ');

        requestsHTML += `
            <div class="request-card ${statusClass}">
                <div class="request-details-grid">
                    <div class="request-meta-item">
                        <span class="request-meta-label">Title</span>
                        <span class="request-meta-value">${request.title || 'Untitled Request'}</span>
                    </div>
                    <div class="request-meta-item">
                        <span class="request-meta-label">Category</span>
                        <span class="request-meta-value">
                            <span class="badge bg-light text-dark">${request.category || 'Uncategorized'}</span>
                        </span>
                    </div>
                    <div class="request-meta-item">
                        <span class="request-meta-label">Status</span>
                        <span class="request-meta-value">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </span>
                    </div>
                    <div class="request-meta-item">
                        <span class="request-meta-label">Date</span>
                        <span class="request-meta-value">
                            <i class="bi bi-calendar me-1"></i>${dateStr}
                        </span>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-truncate" style="max-width: 60%;">
                        <small class="text-muted">
                            ${request.description ? request.description.substring(0, 100) + '...' : 'No description'}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary btn-sm view-request-btn" data-id="${request.id}">
                            <i class="bi bi-eye me-1"></i>View Details
                        </button>
                    </div>
                </div>
                <div class="mt-2 text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Debug: Request #${index + 1} | Status: ${request.status} | User: ${request.submitterEmail || 'No email'}
                </div>
            </div>
        `;
    });

    container.innerHTML = requestsHTML;

    // Add event listeners to view buttons
    container.querySelectorAll('.view-request-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const requestId = e.target.closest('button').getAttribute('data-id');
            this.viewRequestDetails(requestId);
        });
    });
}

            updateDateTime() {
                const updateTime = () => {
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const timeStr = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    document.getElementById('currentDate').textContent = dateStr;
                    document.getElementById('currentTime').textContent = timeStr;
                    document.getElementById('currentTime2').textContent = timeStr;
                };

                updateTime();
                this.dateTimeInterval = setInterval(updateTime, 60000); // Update every minute
            }

            // Session management
            startSessionTimer() {
                // Clear existing timeout
                if (this.sessionTimeout) {
                    clearTimeout(this.sessionTimeout);
                }

                // Set new timeout for 30 minutes
                this.sessionTimeout = setTimeout(() => {
                    this.showSessionWarning();
                }, 25 * 60 * 1000); // 25 minutes (warning after 25)
            }

            showSessionWarning() {
                // Create warning div
                const warningDiv = document.createElement('div');
                warningDiv.className = 'session-warning';
                warningDiv.innerHTML = `
                    <strong><i class="bi bi-exclamation-triangle"></i> Session Expiring Soon!</strong>
                    <p class="mb-2">Your session will expire in 5 minutes. Please save your work.</p>
                    <button class="btn btn-sm btn-warning" id="extendSessionBtn">
                        Extend Session
                    </button>
                `;
                document.body.appendChild(warningDiv);

                // Add event listener to extend button
                document.getElementById('extendSessionBtn').addEventListener('click', () => {
                    warningDiv.remove();
                    this.resetSessionTimer();
                });

                // Set final timeout for 5 more minutes
                this.sessionWarningTimeout = setTimeout(() => {
                    warningDiv.remove();
                    alert('Your session has expired. You will be logged out.');
                    this.logout();
                }, 5 * 60 * 1000); // 5 minutes
            }

            resetSessionTimer() {
                this.startSessionTimer();
            }

            setupEventListeners() {
                const self = this;

                // Mobile menu toggle
                document.getElementById('mobileMenuToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('active');
                });

                // Close mobile menu when clicking outside on mobile
                document.addEventListener('click', (e) => {
                    const sidebar = document.getElementById('sidebar');
                    const menuToggle = document.getElementById('mobileMenuToggle');

                    if (window.innerWidth <= 768 &&
                        sidebar.classList.contains('active') &&
                        !sidebar.contains(e.target) &&
                        e.target !== menuToggle &&
                        !menuToggle.contains(e.target)) {
                        sidebar.classList.remove('active');
                    }
                });

                // Navigation links
                document.getElementById('dashboardLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    self.showView('dashboard');
                });

                document.getElementById('newRequestLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    self.showView('newRequest');
                });

                document.getElementById('myRequestsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    self.showView('myRequests');
                });

                // Event delegation for dynamically created buttons
                document.addEventListener('click', (e) => {
                    // Show new request buttons
                    if (e.target.closest('.show-new-request')) {
                        e.preventDefault();
                        self.showView('newRequest');
                    }

                    // View my requests buttons
                    if (e.target.closest('.view-my-requests')) {
                        e.preventDefault();
                        self.showView('myRequests');
                    }

                    // Back to dashboard button in My Requests
                    if (e.target.closest('.back-to-dashboard-btn')) {
                        e.preventDefault();
                        self.showView('dashboard');
                    }

                    // Cancel button in new request form
                    if (e.target.closest('.cancel-btn')) {
                        e.preventDefault();
                        self.showView('dashboard');
                    }

                    // Logout button
                    if (e.target.closest('#logoutBtn')) {
                        e.preventDefault();
                        self.logout();
                    }
                });

                // Notifications button
                document.getElementById('notificationsBtn').addEventListener('click', () => {
                    const pendingCount = self.data.requests.filter(r => r.status === 'pending').length;
                    if (pendingCount === 0) {
                        alert('No pending notifications!');
                    } else {
                        alert(`You have ${pendingCount} pending request${pendingCount !== 1 ? 's' : ''}.`);
                    }
                });

                // Refresh dashboard buttons
                const refreshDashboard = () => {
                    self.loadUserRequests();
                    self.determineUserView();
                    if (!self.isNewUser) {
                        self.loadDashboardData();
                    }

                    // Show feedback
                    const btn = event?.target || document.querySelector('#refreshDashboardBtn2');
                    if (btn) {
                        const originalHTML = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check2 me-2"></i>Refreshed!';
                        btn.classList.add('btn-success');
                        btn.classList.remove('btn-outline-secondary');

                        setTimeout(() => {
                            btn.innerHTML = originalHTML;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-outline-secondary');
                        }, 1500);
                    }
                };

                document.getElementById('refreshDashboardBtn')?.addEventListener('click', refreshDashboard);
                document.getElementById('refreshDashboardBtn2')?.addEventListener('click', refreshDashboard);

                // Request filters
                document.getElementById('applyFiltersBtn')?.addEventListener('click', () => {
                    self.filters.status = document.getElementById('statusFilter').value;
                    self.filters.category = document.getElementById('categoryFilter').value;
                    self.filters.sort = document.getElementById('sortFilter').value;
                    self.renderMyRequests();
                });

                document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
                    document.getElementById('statusFilter').value = 'all';
                    document.getElementById('categoryFilter').value = 'all';
                    document.getElementById('sortFilter').value = 'newest';
                    self.filters = { status: 'all', category: 'all', sort: 'newest' };
                    self.renderMyRequests();
                });

                // Tour button for new users
                document.getElementById('tourBtn')?.addEventListener('click', () => {
                    alert('Welcome to AMC Content System!\n\n1. Click "New Request" to create content requests\n2. Track your requests in "My Requests"\n\nLet\'s get started!');
                });

                // Initialize filters if they exist
                if (document.getElementById('statusFilter')) {
                    document.getElementById('statusFilter').value = self.filters.status;
                }
                if (document.getElementById('categoryFilter')) {
                    document.getElementById('categoryFilter').value = self.filters.category;
                }
                if (document.getElementById('sortFilter')) {
                    document.getElementById('sortFilter').value = self.filters.sort;
                }

                // Reset session timer on user activity
                document.addEventListener('click', () => self.resetSessionTimer());
                document.addEventListener('keypress', () => self.resetSessionTimer());
                document.addEventListener('mousemove', () => self.resetSessionTimer());
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            window.dashboard = new RequesterDashboard();
            window.dashboard.init();
        });
    </script>
</body>

</html>