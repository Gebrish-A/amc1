<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Calendar - Amhara Media CMS</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #7209b7;
            --danger-color: #e63946;
            --warning-color: #f4a261;
            --success-color: #2a9d8f;
            --border-radius: 12px;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .calendar-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
        }
        
        .fc-toolbar {
            display: none; /* Hide default toolbar, we have our own */
        }
        
        .fc-event {
            border-radius: 6px;
            border: none;
            padding: 2px 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .fc-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .event-category-news { background-color: #4361ee; }
        .event-category-sports { background-color: #2a9d8f; }
        .event-category-entertainment { background-color: #f72585; }
        .event-category-politics { background-color: #7209b7; }
        .event-category-business { background-color: #f4a261; }
        .event-category-culture { background-color: #4cc9f0; }
        .event-category-technical { background-color: #2b2d42; }
        
        .event-priority-high { border-left: 4px solid var(--danger-color); }
        .event-priority-medium { border-left: 4px solid var(--warning-color); }
        .event-priority-low { border-left: 4px solid var(--success-color); }
        
        .event-item {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .event-item:hover {
            background: white;
            box-shadow: var(--shadow-sm);
            transform: translateX(5px);
        }
        
        .event-item.conflict {
            border-left-color: var(--danger-color);
            background: rgba(230, 57, 70, 0.05);
        }
        
        .conflict-badge {
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        
        .status-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        
        .resource-tag {
            display: inline-block;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary-color);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0.1rem;
        }
        
        #calendar {
            min-height: 600px;
        }
        
        /* Custom calendar header */
        .custom-calendar-header {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }
        
        @media (max-width: 768px) {
            #calendar {
                min-height: 400px;
            }
            
            .custom-calendar-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="bi bi-calendar-event me-2"></i>Event Calendar
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="requests.html">
                            <i class="bi bi-send-check me-1"></i>Requests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="calendar.html">
                            <i class="bi bi-calendar-event me-1"></i>Calendar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">
                            <i class="bi bi-person me-1"></i>Profile
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container-fluid pt-4 px-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 fw-bold mb-1">Event Calendar</h1>
                            <p class="text-muted mb-0">Schedule and manage coverage events and assignments</p>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newEventModal">
                            <i class="bi bi-plus-circle me-1"></i>New Event
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Controls -->
            <div class="custom-calendar-header mb-4">
                <div class="d-flex align-items-center">
                    <h4 class="mb-0 me-3" id="currentPeriod">Current Period</h4>
                    <div class="btn-group me-3">
                        <button class="btn btn-outline-primary" id="todayBtn">
                            <i class="bi bi-calendar-day me-1"></i>Today
                        </button>
                        <button class="btn btn-outline-primary" id="prevBtn">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="btn btn-outline-primary" id="nextBtn">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary active" id="monthView" data-view="dayGridMonth">
                        <i class="bi bi-calendar-month me-1"></i>Month
                    </button>
                    <button class="btn btn-outline-primary" id="weekView" data-view="timeGridWeek">
                        <i class="bi bi-calendar-week me-1"></i>Week
                    </button>
                    <button class="btn btn-outline-primary" id="dayView" data-view="timeGridDay">
                        <i class="bi bi-calendar-day me-1"></i>Day
                    </button>
                    <button class="btn btn-outline-primary" id="listView" data-view="listMonth">
                        <i class="bi bi-list-task me-1"></i>List
                    </button>
                </div>
            </div>

            <!-- Calendar -->
            <div class="row">
                <div class="col-12">
                    <div class="calendar-container">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>

            <!-- Stats & Upcoming Events -->
            <div class="row mt-4">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i>Upcoming Events
                            </h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown">
                                    <i class="bi bi-filter me-1"></i>Filter
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="filterEvents('all')">All Events</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterEvents('today')">Today</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterEvents('week')">This Week</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="filterEvents('mine')">My Events</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="upcomingEvents">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading upcoming events...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle me-2 text-warning"></i>Resource Conflicts
                            </h6>
                            <span class="badge bg-danger" id="conflictCount">0</span>
                        </div>
                        <div class="card-body">
                            <div id="conflictsList">
                                <div class="text-center py-4">
                                    <p class="text-muted">Checking for conflicts...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="card border-0 shadow-sm mt-4">
                        <div class="card-header bg-white border-0">
                            <h6 class="mb-0">
                                <i class="bi bi-bar-chart me-2"></i>Calendar Stats
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <div class="bg-primary bg-opacity-10 rounded p-2">
                                        <h4 class="mb-1 text-primary" id="totalEvents">0</h4>
                                        <small class="text-muted">Total Events</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="bg-warning bg-opacity-10 rounded p-2">
                                        <h4 class="mb-1 text-warning" id="upcomingCount">0</h4>
                                        <small class="text-muted">Upcoming</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-success bg-opacity-10 rounded p-2">
                                        <h4 class="mb-1 text-success" id="completedCount">0</h4>
                                        <small class="text-muted">Completed</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="bg-info bg-opacity-10 rounded p-2">
                                        <h4 class="mb-1 text-info" id="conflictsDetected">0</h4>
                                        <small class="text-muted">Conflicts</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Event Modal -->
    <div class="modal fade" id="newEventModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schedule New Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm" novalidate>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventTitle" class="form-label">Event Title *</label>
                                    <input type="text" class="form-control" id="eventTitle" required>
                                    <div class="invalid-feedback">Please enter an event title.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventCategory" class="form-label">Category *</label>
                                    <select class="form-select" id="eventCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="news">News</option>
                                        <option value="sports">Sports</option>
                                        <option value="entertainment">Entertainment</option>
                                        <option value="politics">Politics</option>
                                        <option value="business">Business</option>
                                        <option value="culture">Culture</option>
                                        <option value="technical">Technical</option>
                                        <option value="meeting">Meeting</option>
                                        <option value="training">Training</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a category.</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventStart" class="form-label">Start Date & Time *</label>
                                    <input type="datetime-local" class="form-control" id="eventStart" required>
                                    <div class="invalid-feedback">Please select a start date and time.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventEnd" class="form-label">End Date & Time *</label>
                                    <input type="datetime-local" class="form-control" id="eventEnd" required>
                                    <div class="invalid-feedback">Please select an end date and time.</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="eventLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="eventLocation" 
                                   placeholder="e.g., Main Studio, Conference Room, Field Location">
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="eventDescription" rows="3" 
                                      placeholder="Describe the event, objectives, and requirements..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventPriority" class="form-label">Priority</label>
                                    <select class="form-select" id="eventPriority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="eventStatus" class="form-label">Status</label>
                                    <select class="form-select" id="eventStatus">
                                        <option value="scheduled" selected>Scheduled</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Assign to Team</label>
                            <div id="teamSelection" class="d-flex flex-wrap gap-2">
                                <!-- Team members will be loaded dynamically -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Required Resources</label>
                            <div id="resourceSelection" class="d-flex flex-wrap gap-2">
                                <!-- Resources will be loaded dynamically -->
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Events will automatically check for resource conflicts upon saving.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEventBtn">
                        <i class="bi bi-check-circle me-1"></i>Save Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- Event details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editEventBtn">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteEventBtn">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Calendar JavaScript -->
    <script>
        // Calendar Manager
        class CalendarManager {
            constructor() {
                this.calendar = null;
                this.events = [];
                this.currentEventId = null;
                this.currentView = 'dayGridMonth';
                this.currentDate = new Date();
            }
            
            // Initialize calendar
            init() {
                this.setupEventListeners();
                this.initializeCalendar();
                this.loadEvents();
                this.loadUpcomingEvents();
                this.loadResourceConflicts();
                this.loadCalendarStats();
                this.loadTeamMembers();
                this.loadResources();
            }
            
            // Setup event listeners
            setupEventListeners() {
                // Calendar navigation
                document.getElementById('todayBtn').addEventListener('click', () => this.goToToday());
                document.getElementById('prevBtn').addEventListener('click', () => this.navigate('prev'));
                document.getElementById('nextBtn').addEventListener('click', () => this.navigate('next'));
                
                // View buttons
                document.getElementById('monthView').addEventListener('click', () => this.changeView('dayGridMonth'));
                document.getElementById('weekView').addEventListener('click', () => this.changeView('timeGridWeek'));
                document.getElementById('dayView').addEventListener('click', () => this.changeView('timeGridDay'));
                document.getElementById('listView').addEventListener('click', () => this.changeView('listMonth'));
                
                // Save event button
                document.getElementById('saveEventBtn').addEventListener('click', () => this.saveEvent());
                
                // Delete event button
                document.getElementById('deleteEventBtn').addEventListener('click', () => this.deleteEvent());
                
                // Edit event button
                document.getElementById('editEventBtn').addEventListener('click', () => this.editEvent());
                
                // Modal close handlers
                const newEventModal = document.getElementById('newEventModal');
                if (newEventModal) {
                    newEventModal.addEventListener('hidden.bs.modal', () => {
                        document.getElementById('eventForm').reset();
                        document.getElementById('eventForm').classList.remove('was-validated');
                    });
                }
                
                // Form validation
                const eventForm = document.getElementById('eventForm');
                if (eventForm) {
                    eventForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        if (eventForm.checkValidity()) {
                            this.saveEvent();
                        } else {
                            eventForm.classList.add('was-validated');
                        }
                    });
                }
            }
            
            // Initialize FullCalendar
            initializeCalendar() {
                const calendarEl = document.getElementById('calendar');
                
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: this.currentView,
                    initialDate: this.currentDate,
                    headerToolbar: false, // We have custom header
                    height: 'auto',
                    editable: true,
                    selectable: true,
                    selectMirror: true,
                    dayMaxEvents: true,
                    weekends: true,
                    nowIndicator: true,
                    firstDay: 1, // Monday
                    locale: 'en',
                    timeZone: 'local',
                    eventTimeFormat: {
                        hour: '2-digit',
                        minute: '2-digit',
                        meridiem: 'short'
                    },
                    eventDisplay: 'block',
                    eventDidMount: this.styleEvent.bind(this),
                    eventClick: this.handleEventClick.bind(this),
                    dateClick: this.handleDateClick.bind(this),
                    events: this.fetchEvents.bind(this),
                    eventDrop: this.handleEventDrop.bind(this),
                    eventResize: this.handleEventResize.bind(this),
                    select: this.handleDateSelect.bind(this)
                });
                
                this.calendar.render();
                this.updateCurrentPeriod();
            }
            
            // Change calendar view
            changeView(view) {
                // Update active button
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-view="${view}"]`).classList.add('active');
                
                this.currentView = view;
                this.calendar.changeView(view);
                this.updateCurrentPeriod();
            }
            
            // Navigate calendar
            navigate(direction) {
                this.calendar[`${direction}()`]();
                this.updateCurrentPeriod();
            }
            
            // Go to today
            goToToday() {
                this.calendar.today();
                this.updateCurrentPeriod();
            }
            
            // Update current period display
            updateCurrentPeriod() {
                const view = this.calendar.view;
                let periodText = '';
                
                switch(view.type) {
                    case 'dayGridMonth':
                        periodText = view.currentStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        break;
                    case 'timeGridWeek':
                        const start = view.currentStart;
                        const end = view.currentEnd;
                        periodText = `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                        break;
                    case 'timeGridDay':
                        periodText = view.currentStart.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                        break;
                    case 'listMonth':
                        periodText = view.currentStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        break;
                }
                
                document.getElementById('currentPeriod').textContent = periodText;
            }
            
            // Style events
            styleEvent(info) {
                const event = info.event;
                const category = event.extendedProps.category || 'general';
                const priority = event.extendedProps.priority || 'medium';
                
                // Add category class
                info.el.classList.add(`event-category-${category}`);
                
                // Add priority class
                info.el.classList.add(`event-priority-${priority}`);
                
                // Add conflict styling
                if (event.extendedProps.hasConflict) {
                    info.el.classList.add('conflict');
                    info.el.title = 'Resource Conflict - Click for details';
                }
                
                // Add tooltip
                if (event.extendedProps.description) {
                    info.el.title = `${event.title}\n${event.extendedProps.description}`;
                }
            }
            
            // Handle event click
            async handleEventClick(info) {
                const event = info.event;
                this.currentEventId = event.id;
                
                await this.showEventDetails(event);
            }
            
            // Handle date click
            handleDateClick(info) {
                const modal = new bootstrap.Modal(document.getElementById('newEventModal'));
                
                // Set default times
                const startDate = new Date(info.date);
                const endDate = new Date(startDate.getTime() + 2 * 60 * 60 * 1000); // 2 hours later
                
                document.getElementById('eventStart').value = this.formatDateTimeLocal(startDate);
                document.getElementById('eventEnd').value = this.formatDateTimeLocal(endDate);
                
                modal.show();
            }
            
            // Handle date select
            handleDateSelect(info) {
                const modal = new bootstrap.Modal(document.getElementById('newEventModal'));
                
                document.getElementById('eventStart').value = this.formatDateTimeLocal(info.start);
                document.getElementById('eventEnd').value = this.formatDateTimeLocal(info.end);
                
                modal.show();
                this.calendar.unselect(); // Clear selection
            }
            
            // Handle event drop
            async handleEventDrop(info) {
                const event = info.event;
                const updates = {
                    start: event.start,
                    end: event.end,
                    allDay: event.allDay
                };
                
                await this.updateEvent(event.id, updates);
            }
            
            // Handle event resize
            async handleEventResize(info) {
                const event = info.event;
                const updates = {
                    start: event.start,
                    end: event.end
                };
                
                await this.updateEvent(event.id, updates);
            }
            
            // Fetch events for calendar
            async fetchEvents(fetchInfo, successCallback, failureCallback) {
                try {
                    const response = await this.apiRequest(`/calendar/events?start=${fetchInfo.start.toISOString()}&end=${fetchInfo.end.toISOString()}`);
                    
                    if (response.success) {
                        const events = response.data.events || [];
                        successCallback(events.map(event => ({
                            id: event._id,
                            title: event.title,
                            start: event.start,
                            end: event.end,
                            allDay: event.allDay || false,
                            backgroundColor: this.getEventColor(event.category),
                            borderColor: this.getPriorityColor(event.priority),
                            extendedProps: {
                                category: event.category,
                                priority: event.priority,
                                location: event.location,
                                description: event.description,
                                status: event.status,
                                hasConflict: event.hasConflict || false,
                                assignedTo: event.assignedTo,
                                resources: event.resources
                            }
                        })));
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                }
            }
            
            // Load all events
            async loadEvents() {
                try {
                    const response = await this.apiRequest('/calendar/events');
                    
                    if (response.success) {
                        this.events = response.data.events || [];
                        this.updateCalendarStats();
                    }
                } catch (error) {
                    console.error('Error loading events:', error);
                    this.showToast('Failed to load events', 'error');
                }
            }
            
            // Load upcoming events
            async loadUpcomingEvents() {
                try {
                    const container = document.getElementById('upcomingEvents');
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    `;
                    
                    const response = await this.apiRequest('/calendar/events/upcoming');
                    
                    if (response.success) {
                        const events = response.data.events || [];
                        this.renderUpcomingEvents(events);
                    }
                } catch (error) {
                    console.error('Error loading upcoming events:', error);
                    document.getElementById('upcomingEvents').innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-muted">Failed to load upcoming events</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="calendarManager.loadUpcomingEvents()">
                                Retry
                            </button>
                        </div>
                    `;
                }
            }
            
            // Render upcoming events
            renderUpcomingEvents(events) {
                const container = document.getElementById('upcomingEvents');
                
                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-calendar-x text-muted display-6"></i>
                            <p class="mt-3 text-muted">No upcoming events</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                events.forEach(event => {
                    const startDate = new Date(event.start);
                    const endDate = new Date(event.end);
                    const hasConflict = event.hasConflict || false;
                    
                    html += `
                        <div class="event-item ${hasConflict ? 'conflict' : ''}" 
                             onclick="calendarManager.showEventDetailsModal('${event._id}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${this.escapeHtml(event.title)}</strong>
                                    ${hasConflict ? '<span class="conflict-badge ms-2">Conflict</span>' : ''}
                                    <div class="small text-muted mt-1">
                                        <i class="bi bi-clock me-1"></i>
                                        ${this.formatEventTime(startDate, endDate)}
                                    </div>
                                    ${event.location ? `
                                        <div class="small text-muted">
                                            <i class="bi bi-geo-alt me-1"></i>
                                            ${this.escapeHtml(event.location)}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-end">
                                    <span class="badge ${this.getCategoryClass(event.category)}">
                                        ${event.category}
                                    </span>
                                </div>
                            </div>
                            ${event.assignedTo?.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-muted">Assigned to: </small>
                                    ${event.assignedTo.map(user => 
                                        `<span class="resource-tag">${user.name}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // Load resource conflicts
            async loadResourceConflicts() {
                try {
                    const response = await this.apiRequest('/calendar/conflicts');
                    
                    if (response.success) {
                        const conflicts = response.data.conflicts || [];
                        this.renderResourceConflicts(conflicts);
                        document.getElementById('conflictCount').textContent = conflicts.length;
                    }
                } catch (error) {
                    console.error('Error loading conflicts:', error);
                }
            }
            
            // Render resource conflicts
            renderResourceConflicts(conflicts) {
                const container = document.getElementById('conflictsList');
                
                if (conflicts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="bi bi-check-circle text-success display-6"></i>
                            <p class="mt-3 text-success">No resource conflicts</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                conflicts.forEach(conflict => {
                    html += `
                        <div class="alert alert-warning mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${conflict.resource}</strong>
                                    <p class="mb-1 small">${conflict.conflictType} conflict</p>
                                    <p class="mb-0 small text-muted">
                                        Affected events: ${conflict.events.map(e => e.title).join(', ')}
                                    </p>
                                </div>
                                <button class="btn btn-sm btn-outline-warning" 
                                        onclick="calendarManager.resolveConflict('${conflict.resource}')">
                                    Resolve
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // Load calendar stats
            async loadCalendarStats() {
                try {
                    const response = await this.apiRequest('/calendar/stats');
                    
                    if (response.success) {
                        const stats = response.data;
                        this.updateCalendarStats(stats);
                    }
                } catch (error) {
                    console.error('Error loading calendar stats:', error);
                }
            }
            
            // Update calendar stats
            updateCalendarStats(stats = {}) {
                document.getElementById('totalEvents').textContent = stats.totalEvents || this.events.length;
                document.getElementById('upcomingCount').textContent = stats.upcomingCount || 0;
                document.getElementById('completedCount').textContent = stats.completedCount || 0;
                document.getElementById('conflictsDetected').textContent = stats.conflictCount || 0;
            }
            
            // Load team members
            async loadTeamMembers() {
                try {
                    const response = await this.apiRequest('/users/team');
                    
                    if (response.success) {
                        const members = response.data.members || [];
                        this.renderTeamSelection(members);
                    }
                } catch (error) {
                    console.error('Error loading team members:', error);
                }
            }
            
            // Render team selection
            renderTeamSelection(members) {
                const container = document.getElementById('teamSelection');
                
                let html = '';
                members.forEach(member => {
                    html += `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" 
                                   id="team-${member._id}" value="${member._id}">
                            <label class="form-check-label" for="team-${member._id}">
                                ${member.name}
                            </label>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // Load resources
            async loadResources() {
                try {
                    const response = await this.apiRequest('/calendar/resources');
                    
                    if (response.success) {
                        const resources = response.data.resources || [];
                        this.renderResourceSelection(resources);
                    }
                } catch (error) {
                    console.error('Error loading resources:', error);
                }
            }
            
            // Render resource selection
            renderResourceSelection(resources) {
                const container = document.getElementById('resourceSelection');
                
                let html = '';
                resources.forEach(resource => {
                    html += `
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" 
                                   id="resource-${resource._id}" value="${resource._id}">
                            <label class="form-check-label" for="resource-${resource._id}">
                                ${resource.name} (${resource.type})
                            </label>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // Save new event
            async saveEvent() {
                const form = document.getElementById('eventForm');
                
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                try {
                    // Collect form data
                    const eventData = {
                        title: document.getElementById('eventTitle').value.trim(),
                        category: document.getElementById('eventCategory').value,
                        start: document.getElementById('eventStart').value,
                        end: document.getElementById('eventEnd').value,
                        location: document.getElementById('eventLocation').value.trim(),
                        description: document.getElementById('eventDescription').value.trim(),
                        priority: document.getElementById('eventPriority').value,
                        status: document.getElementById('eventStatus').value,
                        assignedTo: Array.from(document.querySelectorAll('#teamSelection input:checked'))
                                     .map(input => input.value),
                        resources: Array.from(document.querySelectorAll('#resourceSelection input:checked'))
                                     .map(input => input.value)
                    };
                    
                    // Validate dates
                    const start = new Date(eventData.start);
                    const end = new Date(eventData.end);
                    
                    if (end <= start) {
                        this.showToast('End time must be after start time', 'warning');
                        return;
                    }
                    
                    // Show loading
                    const saveBtn = document.getElementById('saveEventBtn');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin me-1"></i>Saving...';
                    saveBtn.disabled = true;
                    
                    // Save event
                    const response = await this.apiRequest('/calendar/events', {
                        method: 'POST',
                        body: JSON.stringify(eventData)
                    });
                    
                    if (response.success) {
                        this.showToast('Event saved successfully!', 'success');
                        
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('newEventModal'));
                        modal.hide();
                        
                        // Refresh data
                        this.calendar.refetchEvents();
                        this.loadUpcomingEvents();
                        this.loadResourceConflicts();
                        this.loadCalendarStats();
                    } else {
                        throw new Error(response.message);
                    }
                    
                } catch (error) {
                    console.error('Error saving event:', error);
                    this.showToast('Failed to save event: ' + error.message, 'error');
                } finally {
                    const saveBtn = document.getElementById('saveEventBtn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Save Event';
                        saveBtn.disabled = false;
                    }
                }
            }
            
            // Show event details
            async showEventDetails(event) {
                try {
                    const response = await this.apiRequest(`/calendar/events/${event.id}`);
                    
                    if (response.success) {
                        const eventData = response.data;
                        await this.showEventDetailsModal(eventData);
                    }
                } catch (error) {
                    console.error('Error loading event details:', error);
                    this.showToast('Failed to load event details', 'error');
                }
            }
            
            // Show event details modal
            async showEventDetailsModal(eventId) {
                try {
                    const response = await this.apiRequest(`/calendar/events/${eventId}`);
                    
                    if (response.success) {
                        const event = response.data;
                        
                        // Update modal title
                        document.getElementById('eventModalTitle').textContent = event.title;
                        
                        // Build event details HTML
                        const startDate = new Date(event.start);
                        const endDate = new Date(event.end);
                        const duration = this.calculateDuration(startDate, endDate);
                        
                        let html = `
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="badge ${this.getCategoryClass(event.category)} me-2">
                                            ${event.category}
                                        </span>
                                        <span class="badge ${this.getPriorityClass(event.priority)}">
                                            ${event.priority} Priority
                                        </span>
                                        <span class="badge ${this.getStatusClass(event.status)} ms-2">
                                            ${event.status}
                                        </span>
                                        ${event.hasConflict ? '<span class="badge bg-danger ms-2">Conflict</span>' : ''}
                                    </div>
                                    <div class="text-muted small">
                                        Created: ${new Date(event.createdAt).toLocaleDateString()}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <strong><i class="bi bi-calendar me-2"></i>Date & Time</strong>
                                        <div class="mt-1">
                                            ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            <br>
                                            to ${endDate.toLocaleDateString()} ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            <small class="text-muted">(${duration})</small>
                                        </div>
                                    </div>
                                </div>
                                ${event.location ? `
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <strong><i class="bi bi-geo-alt me-2"></i>Location</strong>
                                            <div class="mt-1">${this.escapeHtml(event.location)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${event.description ? `
                                <div class="mb-4">
                                    <strong><i class="bi bi-card-text me-2"></i>Description</strong>
                                    <div class="mt-2 p-3 bg-light rounded">${this.escapeHtml(event.description)}</div>
                                </div>
                            ` : ''}
                            
                            ${event.assignedTo?.length > 0 ? `
                                <div class="mb-4">
                                    <strong><i class="bi bi-people me-2"></i>Assigned Team</strong>
                                    <div class="mt-2 d-flex flex-wrap gap-2">
                                        ${event.assignedTo.map(user => 
                                            `<span class="resource-tag">${user.name}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${event.resources?.length > 0 ? `
                                <div class="mb-4">
                                    <strong><i class="bi bi-tools me-2"></i>Required Resources</strong>
                                    <div class="mt-2 d-flex flex-wrap gap-2">
                                        ${event.resources.map(resource => 
                                            `<span class="resource-tag">${resource.name}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        `;
                        
                        document.getElementById('eventModalBody').innerHTML = html;
                        
                        // Update button handlers
                        const editBtn = document.getElementById('editEventBtn');
                        const deleteBtn = document.getElementById('deleteEventBtn');
                        
                        editBtn.onclick = () => this.editEvent(event._id);
                        deleteBtn.onclick = () => this.confirmDeleteEvent(event._id);
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
                        modal.show();
                    }
                } catch (error) {
                    console.error('Error loading event details:', error);
                    this.showToast('Failed to load event details', 'error');
                }
            }
            
            // Edit event
            editEvent(eventId) {
                window.location.href = `edit-event.html?id=${eventId}`;
            }
            
            // Confirm delete event
            confirmDeleteEvent(eventId) {
                this.showConfirmModal(
                    'Delete Event',
                    'Are you sure you want to delete this event? This action cannot be undone.',
                    'Delete',
                    'danger',
                    () => this.deleteEvent(eventId)
                );
            }
            
            // Delete event
            async deleteEvent(eventId) {
                try {
                    const response = await this.apiRequest(`/calendar/events/${eventId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.success) {
                        this.showToast('Event deleted successfully!', 'success');
                        
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
                        modal.hide();
                        
                        // Refresh data
                        this.calendar.refetchEvents();
                        this.loadUpcomingEvents();
                        this.loadResourceConflicts();
                        this.loadCalendarStats();
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('Error deleting event:', error);
                    this.showToast('Failed to delete event: ' + error.message, 'error');
                }
            }
            
            // Update event
            async updateEvent(eventId, updates) {
                try {
                    const response = await this.apiRequest(`/calendar/events/${eventId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.success) {
                        this.showToast('Event updated successfully!', 'success');
                        this.calendar.refetchEvents();
                        this.loadResourceConflicts();
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('Error updating event:', error);
                    this.showToast('Failed to update event: ' + error.message, 'error');
                }
            }
            
            // Resolve conflict
            async resolveConflict(resource) {
                this.showToast('Opening conflict resolution...', 'info');
                // In a real app, this would navigate to conflict resolution page
            }
            
            // Filter events
            filterEvents(filter) {
                // This would filter the upcoming events list
                this.showToast(`Filtering events: ${filter}`, 'info');
                // Implementation would depend on your API
            }
            
            // Helper: API request
            async apiRequest(endpoint, options = {}) {
                const token = localStorage.getItem('token');
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` })
                    },
                    credentials: 'include'
                };
                
                const mergedOptions = { ...defaultOptions, ...options };
                
                try {
                    const response = await fetch(`/api${endpoint}`, mergedOptions);
                    
                    if (!response.ok) {
                        if (response.status === 401) {
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            window.location.href = 'login.html';
                            throw new Error('Session expired. Please login again.');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }
            
            // Helper: Format datetime-local
            formatDateTimeLocal(date) {
                const d = new Date(date);
                d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                return d.toISOString().slice(0, 16);
            }
            
            // Helper: Format event time
            formatEventTime(start, end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                
                if (startDate.toDateString() === endDate.toDateString()) {
                    // Same day
                    return `${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                } else {
                    // Different days
                    return `${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} to ${endDate.toLocaleDateString()} ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }
            }
            
            // Helper: Calculate duration
            calculateDuration(start, end) {
                const diffMs = end - start;
                const diffHours = Math.floor(diffMs / 3600000);
                const diffMins = Math.floor((diffMs % 3600000) / 60000);
                
                if (diffHours > 0) {
                    return `${diffHours}h ${diffMins}m`;
                }
                return `${diffMins}m`;
            }
            
            // Helper: Get event color
            getEventColor(category) {
                const colors = {
                    'news': '#4361ee',
                    'sports': '#2a9d8f',
                    'entertainment': '#f72585',
                    'politics': '#7209b7',
                    'business': '#f4a261',
                    'culture': '#4cc9f0',
                    'technical': '#2b2d42',
                    'meeting': '#6c757d',
                    'training': '#198754'
                };
                return colors[category] || '#6c757d';
            }
            
            // Helper: Get priority color
            getPriorityColor(priority) {
                const colors = {
                    'low': '#2a9d8f',
                    'medium': '#f4a261',
                    'high': '#e63946',
                    'urgent': '#dc3545'
                };
                return colors[priority] || '#6c757d';
            }
            
            // Helper: Get category class
            getCategoryClass(category) {
                const classes = {
                    'news': 'bg-info',
                    'sports': 'bg-success',
                    'entertainment': 'bg-purple',
                    'politics': 'bg-primary',
                    'business': 'bg-warning text-dark',
                    'culture': 'bg-cyan',
                    'technical': 'bg-dark',
                    'meeting': 'bg-secondary',
                    'training': 'bg-green'
                };
                return classes[category] || 'bg-secondary';
            }
            
            // Helper: Get priority class
            getPriorityClass(priority) {
                const classes = {
                    'low': 'bg-success',
                    'medium': 'bg-warning text-dark',
                    'high': 'bg-danger',
                    'urgent': 'bg-danger'
                };
                return classes[priority] || 'bg-secondary';
            }
            
            // Helper: Get status class
            getStatusClass(status) {
                const classes = {
                    'scheduled': 'bg-primary',
                    'confirmed': 'bg-info',
                    'in_progress': 'bg-warning text-dark',
                    'completed': 'bg-success',
                    'cancelled': 'bg-danger'
                };
                return classes[status] || 'bg-secondary';
            }
            
            // Helper: Escape HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Helper: Show toast
            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer') || this.createToastContainer();
                
                const toastId = 'toast-' + Date.now();
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `toast align-items-center text-bg-${type}`;
                toast.setAttribute('role', 'alert');
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${this.getToastIcon(type)} me-2"></i>
                            ${this.escapeHtml(message)}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" 
                                data-bs-dismiss="toast"></button>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                
                const bsToast = new bootstrap.Toast(toast, { 
                    delay: 3000,
                    autohide: true 
                });
                bsToast.show();
                
                toast.addEventListener('hidden.bs.toast', () => {
                    toast.remove();
                });
            }
            
            // Helper: Get toast icon
            getToastIcon(type) {
                switch(type) {
                    case 'success': return 'bi-check-circle';
                    case 'error': return 'bi-exclamation-circle';
                    case 'warning': return 'bi-exclamation-triangle';
                    default: return 'bi-info-circle';
                }
            }
            
            // Helper: Create toast container
            createToastContainer() {
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
                return container;
            }
            
            // Helper: Show confirmation modal
            showConfirmModal(title, message, confirmText, confirmType, onConfirm) {
                const modalId = 'confirmModal-' + Date.now();
                const modalHtml = `
                    <div class="modal fade" id="${modalId}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${message}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-${confirmType}" id="confirmButton">${confirmText}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = new bootstrap.Modal(document.getElementById(modalId));
                modal.show();
                
                document.getElementById('confirmButton').addEventListener('click', () => {
                    modal.hide();
                    onConfirm();
                    
                    modal._element.addEventListener('hidden.bs.modal', () => {
                        modal._element.remove();
                    });
                });
                
                modal._element.addEventListener('hidden.bs.modal', () => {
                    modal._element.remove();
                });
            }
        }
        
        // Initialize calendar manager
        const calendarManager = new CalendarManager();
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Initialize calendar
            calendarManager.init();
        });
        
        // Expose to window for HTML event handlers
        window.calendarManager = calendarManager;
    </script>
</body>
</html>